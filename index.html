<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"guyver.icu","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="没有困难的任务，只有勇敢的狗狗">
<meta property="og:type" content="website">
<meta property="og:title" content="Guyver&#39;s Blogs">
<meta property="og:url" content="https://guyver.icu/index.html">
<meta property="og:site_name" content="Guyver&#39;s Blogs">
<meta property="og:description" content="没有困难的任务，只有勇敢的狗狗">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Guyver">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://guyver.icu/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Guyver's Blogs</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Guyver's Blogs</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Guyver</p>
  <div class="site-description" itemprop="description">没有困难的任务，只有勇敢的狗狗</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">4</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guyver.icu/2023/03/07/redis%E5%86%85%E5%AD%98%E4%B8%8A%E6%B6%A8%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Guyver">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guyver's Blogs">
      <meta itemprop="description" content="没有困难的任务，只有勇敢的狗狗">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guyver's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/03/07/redis%E5%86%85%E5%AD%98%E4%B8%8A%E6%B6%A8%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">redis内存上涨分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-03-07 21:01:40 / Modified: 21:10:33" itemprop="dateCreated datePublished" datetime="2023-03-07T21:01:40+08:00">2023-03-07</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><blockquote>
<p>通过产线一例redis内存持续增长的问题，引出redis常用的分析手段。</p>
</blockquote>
<p>我们对redis的内存占用做了90%阈值告警，近期redis常常告警内存不足，担心可能是业务变更导致redis使用不当带来的问题，先让工效同学先扩容，抽时间来分析一下。</p>
<h1 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h1><p><img src="/images/redis%E5%86%85%E5%AD%98%E4%B8%8A%E6%B6%A8%E5%88%86%E6%9E%90/2023-03-02-18-51-23.png"><br>收到的是印度区告警，打开监控，redis主从方式部署，过去一个月来内存占用率慢慢上升，确定不是近期业务变更带来的紧急变化。</p>
<p>根据redis实例名，反向检索配置中心，很快定位到了该redis被多个服务所引用过，检查下这些服务这个月前后提交的代码，没有发现可能导致redis变化的commit提交记录。</p>
<p>查看其它区的对应redis实例监控，发现都有类似情况，一个月内慢慢增长，初步判断是同一个原因导致，选择其中内存占用最大的德国区进行分析。</p>
<p>下一步分析redis内的数据，联系工效同学导出一份产线RDB文件，这里采用了Redis Insight工具分析。</p>
<blockquote>
<p>其他推荐的分析工具还有rdbtools,Redis Desktop Manager,分析思路都一样，查看过期时间、不同类型和不同前缀的Key分布。</p>
</blockquote>
<p><img src="/images/redis%E5%86%85%E5%AD%98%E4%B8%8A%E6%B6%A8%E5%88%86%E6%9E%90/2023-03-02-20-04-00.png"><br><img src="/images/redis%E5%86%85%E5%AD%98%E4%B8%8A%E6%B6%A8%E5%88%86%E6%9E%90/2023-03-02-20-05-40.png"><br>zset类型数据的数量最多，内存占用也最多，数据expire主要分布在1~7天。永不过期数据只有22MB，和本次分析无关。重点分析zset类型数据。<br><img src="/images/redis%E5%86%85%E5%AD%98%E4%B8%8A%E6%B6%A8%E5%88%86%E6%9E%90/2023-03-02-20-11-49.png"><br>Keyspace Summary可以聚合出一些Key Summary，但实用价值不大，没有分析出占比Top Key<br><img src="/images/redis%E5%86%85%E5%AD%98%E4%B8%8A%E6%B6%A8%E5%88%86%E6%9E%90/2023-03-02-20-34-39.png"><br><img src="/images/redis%E5%86%85%E5%AD%98%E4%B8%8A%E6%B6%A8%E5%88%86%E6%9E%90/2023-03-02-20-37-26.png"><br>Memory Analyzer提供了高级检索和统计功能，这里过滤出zset集合数据，发现大量的Event开头的数据<br><img src="/images/redis%E5%86%85%E5%AD%98%E4%B8%8A%E6%B6%A8%E5%88%86%E6%9E%90/2023-03-02-20-39-45.png"><br>继续检索，这里的搜索框是key模式匹配，<code>Event*</code>匹配后发现仅有386M，不是主要组成，但由于模式匹配不支持正则中的负向前瞻，没法排除掉<code>Event*</code>继续分析。<br>这里实际业务场景下，多试几次就可以凭借经验找到占比Top Key，但这里为了全面分析，换个工具。</p>
<p>取前N位前缀进行分组聚合，查看每组的Total Memory和Total Keys。这里我们使用rdbtools将rdb数据转成csv文本，再用awk工具分析。</p>
<p>安装rdbtools，将rdb内数据解析到csv中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdb -c memory xxx.rdb -f xxx.csv</span><br></pre></td></tr></table></figure>
<p>再截取前6位前缀做分组聚合</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -F, <span class="string">&#x27;&#123;counts[substr($3,1,6)]+=$4 ; sum+=$4&#125;; END &#123;for(it in counts) print counts[it],counts[it] *100/sum,it&#125;&#x27;</span> xxx.csv |<span class="built_in">sort</span> -nr|<span class="built_in">head</span> -20</span><br></pre></td></tr></table></figure>

<p>可以看到，<code>udbd_</code>占比最高，其次是<code>Event-</code>，反查代码，发现两者都是防重传业</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1546527810 89.3992 ucbd_3</span><br><span class="line">161376822 9.32861 Event-</span><br><span class="line">5753061 0.332564 D-m-30</span><br><span class="line">4316568 0.249525 H-m-30</span><br><span class="line">3842590 0.222126 D-z-30</span><br><span class="line">3619412 0.209225 H-z-30</span><br><span class="line">1262919 0.0730048 ucbd_5</span><br><span class="line">1165892 0.067396 ucbd_7</span><br><span class="line">1134369 0.0655738 S-m-30</span><br><span class="line">620062 0.0358435 ucbd_1</span><br><span class="line">217011 0.0125446 S-z-30</span><br><span class="line">38613 0.00223208 D-com.</span><br><span class="line">14213 0.000821602 H-com.</span><br><span class="line">5709 0.000330017 D-m-50</span><br><span class="line">3658 0.000211456 S-m-50</span><br><span class="line">2610 0.000150875 H-m-50</span><br><span class="line">1794 0.000103705 D-m-10</span><br><span class="line">1662 9.60742e-05 ucbd_8</span><br><span class="line">1575 9.1045e-05 S-m-10</span><br><span class="line">1377 7.95994e-05 D-z-50</span><br></pre></td></tr></table></figure>

<p>可以看到，<code>udbd_</code>占比最高，其次是<code>Event-</code>，反查代码，发现两者都是防重传业务使用。</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>防重传业务，是因为APP上传数据时，因为各种原因可能存在重传情况，重传也基本都是近期数据，这里对每次上传的数据指纹进行记录，下一次同步时发现指纹相同则认为重复上传，不再落库，减少对数据库的调用，节约资源也降低了数据库费用。<br>redis缓存的数据指纹时间越长，效果越好。当年Redis内存打满后，设置好内存淘汰策略即可。</p>
<ul>
<li>noeviction：直接返回错误，不淘汰任何已经存在的redis键</li>
<li>allkeys-lru：所有的键使用lru算法进行淘汰</li>
<li>volatile-lru：有过期时间的使用lru算法进行淘汰</li>
<li>allkeys-random：随机删除redis键</li>
<li>volatile-random：随机删除有过期时间的redis键</li>
<li>volatile-ttl：删除快过期的redis键</li>
<li>volatile-lfu：根据lfu算法从有过期时间的键删除</li>
<li>allkeys-lfu：根据lfu算法从所有键删除</li>
</ul>
<p>防重传业务，理论上时间越久的数据重传可能性越低，可以考虑<code>volatile-ttl</code>，但另一方面，从用户活跃来看，活跃的用户可能短时间内会一直活跃，也可以考虑<code>volatile-lfu</code>，按实际效果评估对数据库最友好的一种策略即可。<br><img src="/images/redis%E5%86%85%E5%AD%98%E4%B8%8A%E6%B6%A8%E5%88%86%E6%9E%90/2023-03-02-18-39-11.png"></p>
<h1 id="延伸"><a href="#延伸" class="headerlink" title="延伸"></a>延伸</h1><h2 id="为什么要使用rdb分析"><a href="#为什么要使用rdb分析" class="headerlink" title="为什么要使用rdb分析"></a>为什么要使用rdb分析</h2><p>分析redis产线问题时，分析监控指标，一个重要的手段是对内部数据进行分析，扫描数据有以下几种方式</p>
<ol>
<li><code>keys</code>命令，简单粗暴，但不支持翻页，在redis单线程下，容易阻塞主线程，复杂度是 O(n），Redis库中的key越多，查找实现代价越大，产生的阻塞时间越长，不推荐使用。</li>
<li><code>scan</code>命令，复杂度同样是O(n)，但通过限制翻页条数不阻塞主线程，原理是redis底层是类hash结构，由一维数组+链表组成，scan遍历的其实是数组，所以要注意并不是每一页都有结果，需要翻到没有下一页为止，而且数组扩缩容时，可能数据会重复。自己可以写脚本去scan数据，但比较麻烦。</li>
<li><code>AOF</code>(Append Only File)，将每次数据修改操作记录append到日志文件中，记录的是命令，日志较大，每隔一段时间会进行rewrite操作（命令之间整合、抵消等），不易丢数据，但恢复慢。</li>
<li><code>RDB</code>(Redis Database)，父进程fork一个子进程 copy on write，不会阻塞父进程对外提供服务，除非数据集超大且CPU性能不好，可能会影响主进程。RDB文件小恢复快，但创建RDB耗时长，适合做备份，但不适合频繁创建rdb快照，一般会结合AOF一起做备份功能，可以将数据丢失可能性降到最低。</li>
</ol>
<blockquote>
<p>Redis persistence详见<a target="_blank" rel="noopener" href="https://redis.io/docs/management/persistence/">官方文档</a></p>
</blockquote>
<p>根据以上特点分析，不需要最新数据，RDB文件小，恢复快，不会阻塞父进程，如果没有历史备份复用，数据集又超大，必须临时导出，可以使用redis从节点导出。</p>
<h2 id="什么场景还需要rdb"><a href="#什么场景还需要rdb" class="headerlink" title="什么场景还需要rdb"></a>什么场景还需要rdb</h2><p>大key分析、数据备份、内存占用高、数据迁移前后比对、性能分析（较多使用复杂类型数据）</p>
<h2 id="rdb分析维度有哪些"><a href="#rdb分析维度有哪些" class="headerlink" title="rdb分析维度有哪些"></a>rdb分析维度有哪些</h2><p>RDB分析是分析redis内数据，其他运行时状态使用在线Metric监控查看。<br>可分析维度有：</p>
<ol>
<li>不同类型数据的内存占用和数量</li>
<li>过期时间分析，不同时间段和永不过期数据</li>
<li>空闲时间分析，观察哪些数据较长时间无人访问</li>
<li>前缀分析，一般业务非独享，会给Key设置业务前缀，避免重复，也方便使用和分析</li>
</ol>
<h2 id="分析工具"><a href="#分析工具" class="headerlink" title="分析工具"></a>分析工具</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/RedisInsight/RedisDesktopManager">Redis Desktop Manager</a>：跨平台的Redis管理工具，支持多平台，提供了一个直观的图形界面，可以用于查看和编辑Redis的键值对数据，以及导入和导出RDB文件。目前官方网站直接推荐RedisInsight。</li>
<li><a target="_blank" rel="noopener" href="https://rdbtools.com/">rdbtools</a>：Python实现，支持命令行，也可以作为python库编写脚本，配合pandas、numpy、matplotlib等库，对Redis中的数据进行分析和可视化展示。目前官方网站直接推荐RedisInsight。</li>
<li><a target="_blank" rel="noopener" href="https://redis.com/redis-enterprise/redis-insight/">RedisInsight</a>：开源的Redis GUI工具，支持多平台，已更新到V2版本，提供了对Redis数据的可视化管理和监控功能，并支持导入和分析RDB文件。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/junegunn/redis-stat">redis-stat</a>：基于命令行的Redis性能分析工具，Ruby实现，支持分析Redis的性能指标、命令、key分布等，支持导入RDB文件进行分析。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/sripathikrishnan/redis-rdb-tools#redis-rdb-cli">redis-rdb-cli</a>：基于命令行的RDB分析工具，Python实现，支持解析rdb文件，内存分析和将rdb转成json。</li>
</ul>
<blockquote>
<p>如果工具分析不够灵活，可以将RDB数据解析出来，然后使用awk、grep或者python脚本等方式去手动分析。</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guyver.icu/2023/02/28/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JSON-Schema/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Guyver">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guyver's Blogs">
      <meta itemprop="description" content="没有困难的任务，只有勇敢的狗狗">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guyver's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/02/28/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JSON-Schema/" class="post-title-link" itemprop="url">深入理解JSON Schema</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-02-28 20:39:39" itemprop="dateCreated datePublished" datetime="2023-02-28T20:39:39+08:00">2023-02-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-03-01 22:12:37" itemprop="dateModified" datetime="2023-03-01T22:12:37+08:00">2023-03-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>整理翻译自 <a target="_blank" rel="noopener" href="https://json-schema.org/understanding-json-schema/index.html">https://json-schema.org/understanding-json-schema/index.html</a></p>
</blockquote>
<p><code>JSON Schema</code>是用于验证JSON数据结构的强大工具。但是，通过阅读其文档来学习使用它，就像通过查看蓝图来学习驾驶汽车。如果您要做的就是开车，则无需知道汽车如何装配在一起。因此，本书旨在成为JSON Schema的友好的驾校教练。它适用于那些想要编写和理解它的人，但是对那些想装配自己的汽车（例如，编写自己的JSON Schema验证器）的人并不适用。</p>
<blockquote>
<p>本书介绍了JSON Schema draft7。较早的JSON Schema版本与此处描述的格式不完全兼容，但是在大多数情况下，这些区别在文本中有所说明。</p>
</blockquote>
<p><strong>从哪里开始？</strong></p>
<ul>
<li>本书使用一些新颖的<a target="_blank" rel="noopener" href="https://json-schema.org/understanding-json-schema/conventions.html#conventions">约定</a>来显示Schema示例，并将JSON Schema与您选择的编程语言相关联。</li>
<li>如果不确定什么是Schema，请查看<a target="_blank" rel="noopener" href="https://json-schema.org/understanding-json-schema/about.html#about">什么是Schema</a>？。</li>
<li><a target="_blank" rel="noopener" href="https://json-schema.org/understanding-json-schema/basics.html#basics">基础知识</a>一章应该足以使您开始理解核心<a target="_blank" rel="noopener" href="https://json-schema.org/understanding-json-schema/reference/index.html#reference">JSON Schema Reference</a>。</li>
<li>当您开始开发具有许多嵌套和重复部分的大型Schema时，请查看<a target="_blank" rel="noopener" href="https://json-schema.org/understanding-json-schema/structuring.html#structuring">构建复杂的Schema</a>。</li>
<li><a target="_blank" rel="noopener" href="https://json-schema.org/">json-schema.org</a>有许多资源，包括用于处理来自各种编程语言的JSON Schema的官方规范和工具。</li>
<li><a target="_blank" rel="noopener" href="https://jsonschema.net/">jsonschema.net</a>是一个在线应用程序，可对示例文档运行您自己的JSON Schema。如果您想在不安装任何软件的情况下进行尝试，这是非常方便的资源。</li>
</ul>
<h1 id="本书中使用的约定"><a href="#本书中使用的约定" class="headerlink" title="本书中使用的约定"></a>本书中使用的约定</h1><h2 id="针对draft的特别说明"><a href="#针对draft的特别说明" class="headerlink" title="针对draft的特别说明"></a><a target="_blank" rel="noopener" href="https://json-schema.org/understanding-json-schema/conventions.html#id2">针对draft的特别说明</a></h2><p>JSON Schema标准已经通过了许多修订或“draft”。最重要的是draft7(在撰写本文时的最新版本)和draft4(在此基础上构建了大量的生产软件)，以及本书的早期版本的draft。<br>编写该文档是为了鼓励使用draft7，并优先考虑最新的约定和功能，但是与以前的draft有所不同的是，在特殊标注中突出了这些区别。如果仅希望将目标定为草稿7，则可以放心忽略这些部分。</p>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p>本书中有很多示例，并且都遵循相同的格式。每个示例的开头是一个简短的JSON Schema，说明了特定的原理，然后是对该 Schema有效或无效的简短JSON代码段。<font color="green">有效示例为绿色</font>，<font color="red">无效的示例为红色</font>，请忽略第一列的+或者-，仅仅是markdown代码块使用diff方式来区分颜色。通常在两者之间会有注释，以解释某些事物为何有效或无效的原因。<br>例如，以下代码段说明了如何使用该number类型：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>整数</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 42</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ -1</span></span><br></pre></td></tr></table></figure>
<p>简单浮点数：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 5.0</span></span><br></pre></td></tr></table></figure>
<p>指数表示法也适用：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 2.99792458e8</span></span><br></pre></td></tr></table></figure>
<p>拒绝将数字作为字符串：</p>
<figure class="highlight diff"><figcaption><span>不匹配schema</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &quot;42&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="什么是Schema？"><a href="#什么是Schema？" class="headerlink" title="什么是Schema？"></a>什么是Schema？</h1><p>如果您曾经使用过XML Schema，RelaxNG或ASN.1，则可能已经知道什么是schema，并且可以很高兴地跳到下一节。如果这一切听起来很懵逼，那么您来对地方了。要定义什么是JSON Schema，我们可能应该首先定义什么是JSON。<br>JSON代表“ JavaScript Object Notation”，这是一种简单的数据交换格式。它最初是作为互联网的一种表示法。由于大多数Web浏览器中都存在JavaScript，并且JSON基于JavaScript，因此很容易在其中进行支持。但是，它已经被证明足够有用和足够简单，现在可以在许多不涉及浏览网页的情况下使用。<br>JSON本质上是基于以下数据结构构建的：</p>
<ul>
<li><p>object：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;key1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;value1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;key2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;value2&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li><p>array：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span> <span class="string">&quot;first&quot;</span><span class="punctuation">,</span> <span class="string">&quot;second&quot;</span><span class="punctuation">,</span> <span class="string">&quot;third&quot;</span> <span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>number：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">42</span></span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3.1415926</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>string：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;This is a string&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>boolean：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal"><span class="keyword">true</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal"><span class="keyword">false</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>null：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal"><span class="keyword">null</span></span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>使用这些简单的数据类型，可以表示所有类型的结构化数据。但是，随着灵活性的提高，责任也随之增加，因为同一概念可以用多种方式表示。例如，您可以想象以不同的方式用JSON表示有关一个人的信息：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;George Washington&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;birthday&quot;</span><span class="punctuation">:</span> <span class="string">&quot;February 22, 1732&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mount Vernon, Virginia, United States&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;first_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;George&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;last_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Washington&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;birthday&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1732-02-22&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;street_address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3200 Mount Vernon Memorial Highway&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mount Vernon&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Virginia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;country&quot;</span><span class="punctuation">:</span> <span class="string">&quot;United States&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>两种表述同等有效，尽管其中一种表述显然比另一种更为正式。记录的设计将在很大程度上取决于其在应用程序中的预期用途，因此这里没有正确或错误的答案。但是，当应用程序说“给我一个人的JSON记录”时，准确知道该记录的组织方式非常重要。例如，我们需要知道预期的字段以及值的表示方式。这就是JSON Schema的来源。以下JSON Schema片段描述了上面第二个示例的结构。现在不必担心太多细节。在随后的章节中将对它们进行说明。</p>
<figure class="highlight json"><figcaption><span>Schema</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;first_name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;last_name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;birthday&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;street_address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;country&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>通过针对该Schema“验证”第一个示例，您可以看到它失败了：</p>
<figure class="highlight diff"><figcaption><span>错误示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123;</span></span><br><span class="line"><span class="deletion">-   &quot;name&quot;: &quot;George Washington&quot;,</span></span><br><span class="line"><span class="deletion">-   &quot;birthday&quot;: &quot;February 22, 1732&quot;,</span></span><br><span class="line"><span class="deletion">-   &quot;address&quot;: &quot;Mount Vernon, Virginia, United States&quot;</span></span><br><span class="line"><span class="deletion">- &#125;</span></span><br></pre></td></tr></table></figure>

<p>但是，第二个示例通过了：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123;</span></span><br><span class="line"><span class="addition">+   &quot;first_name&quot;: &quot;George&quot;,</span></span><br><span class="line"><span class="addition">+   &quot;last_name&quot;: &quot;Washington&quot;,</span></span><br><span class="line"><span class="addition">+   &quot;birthday&quot;: &quot;22-02-1732&quot;,</span></span><br><span class="line"><span class="addition">+   &quot;address&quot;: &#123;</span></span><br><span class="line"><span class="addition">+     &quot;street_address&quot;: &quot;3200 Mount Vernon Memorial Highway&quot;,</span></span><br><span class="line"><span class="addition">+     &quot;city&quot;: &quot;Mount Vernon&quot;,</span></span><br><span class="line"><span class="addition">+     &quot;state&quot;: &quot;Virginia&quot;,</span></span><br><span class="line"><span class="addition">+     &quot;country&quot;: &quot;United States&quot;</span></span><br><span class="line"><span class="addition">+   &#125;</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br></pre></td></tr></table></figure>

<p>您可能已经注意到JSON Schema本身是用JSON编写的。它是数据本身，而不是计算机程序。它只是“描述其他数据的结构”的声明性格式。这既是它的强项，也是它的弱项（与其他类似的Schema语言共享）。简明扼要地描述数据的表面结构，并根据它自动进行数据验证很容易。但是，由于JSONSchema不能包含任意代码，因此无法表达的数据元素之间的关系受到某些限制。因此，任何用于足够复杂的数据格式的“验证工具”都可能具有两个验证阶段：一个在Schema（或结构）级别，另一个在语义级别。后者检查可能需要使用更通用的编程语言来实现。</p>
<h1 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h1><p>在<a target="_blank" rel="noopener" href="https://json-schema.org/understanding-json-schema/about.html#about">什么是Schema中？</a>，我们描述了Schema是什么，并希望证明对Schema Languages的合理性。在这里，我们继续编写一个简单的JSON Schema。</p>
<h2 id="Hello，World！"><a href="#Hello，World！" class="headerlink" title="Hello，World！"></a>Hello，World！</h2><p>学习任何一种新语言时，从尽可能简单的事情开始通常会很有帮助。在JSON Schema中，空对象是一个完全有效的Schema，它将接受任何有效的JSON。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>只要有效的JSON，它就接受任何东西</p>
<figure class="highlight diff"><figcaption><span>正确示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 42</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><figcaption><span>正确示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &quot;I&#x27;m a string&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><figcaption><span>正确示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123;</span></span><br><span class="line"><span class="addition">+     &quot;an&quot;:[</span></span><br><span class="line"><span class="addition">+         &quot;arbitrarily&quot;,</span></span><br><span class="line"><span class="addition">+         &quot;nested&quot;</span></span><br><span class="line"><span class="addition">+     ],</span></span><br><span class="line"><span class="addition">+     &quot;data&quot;:&quot;structure&quot;</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>New feature in draft6</strong>正确示例<br>您也可以true代替空对象来表示匹配任何内容。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal"><span class="keyword">true</span></span></span><br></pre></td></tr></table></figure>

<p>只要有效的JSON，它就匹配任何东西</p>
<figure class="highlight diff"><figcaption><span>正确示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 42</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><figcaption><span>正确示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &quot;I&#x27;m a string&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><figcaption><span>正确示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123;</span></span><br><span class="line"><span class="addition">+     &quot;an&quot;:[</span></span><br><span class="line"><span class="addition">+         &quot;arbitrarily&quot;,</span></span><br><span class="line"><span class="addition">+         &quot;nested&quot;</span></span><br><span class="line"><span class="addition">+     ],</span></span><br><span class="line"><span class="addition">+     &quot;data&quot;:&quot;structure&quot;</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br></pre></td></tr></table></figure>

<p>false表示不匹配任何内容的Schema。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal"><span class="keyword">false</span></span></span><br></pre></td></tr></table></figure>
<p>下面无法匹配</p>
<figure class="highlight diff"><figcaption><span>错误示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &quot;Resistance is futile...  This will always fail!!!&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="type关键字"><a href="#type关键字" class="headerlink" title="type关键字"></a>type关键字</h2><p>当然，如果我们只想接受任何JSON文档，就不会使用JSON Schema。在JSON Schema中，最常见的做法是限制为特定类型。该type关键字用于此处。<br>当本书提到JSON Schema“关键字”时，它表示object中key&#x2F;value对的“key”部分。编写JSON Schema的大部分工作涉及将特殊的“关键字”映射到对象内的值。<br>例如，以下仅接受字符串：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><figcaption><span>正确示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &quot;I&#x27;m a string&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><figcaption><span>错误示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- 42</span></span><br></pre></td></tr></table></figure>

<p>该type关键字在<a target="_blank" rel="noopener" href="https://json-schema.org/understanding-json-schema/reference/type.html#type">Type-specific关键字</a>中有更详细的描述。</p>
<h2 id="声明一个JSON-Schema"><a href="#声明一个JSON-Schema" class="headerlink" title="声明一个JSON Schema"></a>声明一个JSON Schema</h2><p>判断JSON Schema正在使用哪个draft并不总是那么容易。您可以使用<code>$schema</code>关键字来声明将Schema写入哪个版本的JSON Schema规范。有关更多信息，请参见<a target="_blank" rel="noopener" href="https://json-schema.org/understanding-json-schema/reference/schema.html#schema">$schema关键字</a>。包括它通常是一个很好的做法，尽管不是必需的。</p>
<blockquote>
<p>为简洁起见，<code>$schema</code>本书的大多数示例中并未包含该关键字，但应在现实世界中始终使用该关键字。</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;$schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://json-schema.org/draft-07/schema#&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="声明一个唯一的标识符"><a href="#声明一个唯一的标识符" class="headerlink" title="声明一个唯一的标识符"></a>声明一个唯一的标识符</h2><p>最佳做法还包括将<code>$id</code>属性作为每个Schema的唯一标识符。现在，只需将其设置为您控制的域的URL，例如：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;$id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://yourdomain.com/schemas/myschema.json&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>当您开始<a target="_blank" rel="noopener" href="https://json-schema.org/understanding-json-schema/structuring.html#structuring">构建复杂的Schema</a>时，<a target="_blank" rel="noopener" href="https://json-schema.org/understanding-json-schema/structuring.html#id">$id属性</a>的细节变得更加明显。</p>
<h1 id="JSON-Schema参考"><a href="#JSON-Schema参考" class="headerlink" title="JSON Schema参考"></a>JSON Schema参考</h1><h2 id="特定类型的关键字"><a href="#特定类型的关键字" class="headerlink" title="特定类型的关键字"></a>特定类型的关键字</h2><p>该<strong>type</strong>关键字是JSON Schema的基础。它指定Schema的数据类型。<br>JSON Schema的核心定义了以下基本类型：</p>
<ul>
<li>string</li>
<li>number</li>
<li>integer</li>
<li>object</li>
<li>array</li>
<li>boolean</li>
<li>null</li>
</ul>
<p>这些类型在大多数编程语言中都有类似实现，尽管它们的名称可能不同。</p>
<p>type关键字可以是一个字符串或数组：</p>
<ul>
<li>如果是字符串，则为上述基本类型之一。</li>
<li>如果是数组，则必须是字符串数组，其中每个字符串是一种基本类型，并且每个元素都是唯一的。在这种情况下，如果JSON代码段与任何给定类型匹配，则该代码段有效。<br>这是使用type关键字的一个简单示例：<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><figcaption><span>正确示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 42</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><figcaption><span>正确示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 42.0</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>这不是数字，而是包含数字的字符串。</p>
<figure class="highlight diff"><figcaption><span>错误示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &quot;42&quot;</span></span><br></pre></td></tr></table></figure>

<p>在以下示例中，我们接受字符串和数字，但不接受结构化数据类型：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;number&quot;</span><span class="punctuation">,</span> <span class="string">&quot;string&quot;</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><figcaption><span>正确示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 42</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><figcaption><span>正确示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &quot;Life, the universe, and everything&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><figcaption><span>错误示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- [&quot;Life&quot;, &quot;the universe&quot;, &quot;and everything&quot;]</span></span><br></pre></td></tr></table></figure>

<p>对于每种类型，都有仅适用于这些类型的关键字。例如，数字类型具有一种指定数字范围的方法，该方法不适用于其他类型。在本参考文献中，以下各章将对这些验证关键字及其对应的每种类型进行描述。</p>
<h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><p><code>string</code>类型用于文本字符串。它可能包含Unicode字符。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/30873035/answer/995167936?utm_source=wechat_timeline">Unicode 字符集中有哪些神奇的字符？</a></p>
</blockquote>
<h3 id="长度"><a href="#长度" class="headerlink" title="长度"></a>长度</h3><p>可以使用<code>minLength</code>和<code>maxLength</code>关键字来限制字符串的长度。对于两个关键字，该值都必须是非负数。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;minLength&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;maxLength&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &quot;AB&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &quot;ABC&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><figcaption><span>错误示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &quot;A&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><figcaption><span>错误示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &quot;ABCD&quot;</span></span><br></pre></td></tr></table></figure>


<h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><p>pattern关键字被用于限制一个字符串格式的正则表达式。正则表达式语法是JavaScript（特别是<a href="https://security.feishu.cn/link/safety?target=https://www.ecma-international.org/publications/standards/Ecma-262.htm&scene=ccm&logParams=%7B%22location%22:%22ccm_docs%22%7D&lang=zh-CN">ECMA 262</a>）中定义的语法。有关更多信息，请参见<a target="_blank" rel="noopener" href="https://json-schema.org/understanding-json-schema/reference/regular_expressions.html#regular-expressions">正则表达式</a>。</p>
<blockquote>
<p>定义正则表达式时，请务必注意，如果表达式在字符串中的任何位置匹配，则该字符串被视为有效。例如，正则表达式”p” 将匹配其中包含a的任何字符串p，例如”apple”不只是simple的字符串”p”。因此，理所当然地，将正则表达式包含在^…$例如中通常不会造成混淆，”^p$“除非有充分的理由不这样做。</p>
</blockquote>
<p>下面的示例将一个简单的北美电话号码与一个可选的区号进行匹配：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^(\\([0-9]&#123;3&#125;\\))?[0-9]&#123;3&#125;-[0-9]&#123;4&#125;$&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><figcaption><span>正确示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &quot;555-1212&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><figcaption><span>正确示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &quot;(888)555-1212&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><figcaption><span>错误示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &quot;(888)555-1212 ext. 532&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><figcaption><span>错误示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &quot;(800)FLOWERS&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h3><p><code>format</code>关键字允许对某些类型的字符串值，通常使用的基本语义验证。这允许值受到约束，超出了JSON Schema中的其他工具（包括<a target="_blank" rel="noopener" href="https://json-schema.org/understanding-json-schema/reference/regular_expressions.html#regular-expressions">正则表达式</a>）所能提供的范围。</p>
<blockquote>
<p>不需要JSON Schema实现即可实现规范的此部分，并且其中许多不需要。</p>
</blockquote>
<p>JSON Schema规范中倾向于与网络相关的格式，这很可能是由于其在Web技术中的传承。但是，也可以使用自定义格式，只要交换JSON文档的各方也交换有关自定义格式类型的信息即可。JSONSchema验证器将忽略它不理解的任何格式类型。</p>
<h4 id="内置格式"><a href="#内置格式" class="headerlink" title="内置格式"></a>内置格式</h4><p>以下是JSONSchema规范中指定的格式列表。</p>
<h5 id="日期和时间"><a href="#日期和时间" class="headerlink" title="日期和时间"></a>日期和时间</h5><p>日期和时间在<a target="_blank" rel="noopener" href="https://json-schema.org/draft/2020-12/json-schema-validation.html">RFC 3339第5.6节</a>中表示。这是日期格式的子集，通常也称为<a target="_blank" rel="noopener" href="https://www.iso.org/iso-8601-date-and-time-format.html">ISO8601格式</a>。</p>
<ul>
<li><code>&quot;date-time&quot;</code>：日期和时间在一起，例如 2018-11-13T20:20:39+00:00。</li>
<li><code>&quot;time&quot;</code>：例如，draft7 Time中的新增内容，20:20:39+00:00</li>
<li><code>&quot;date&quot;</code>：例如，draft7日期中的新增内容2018-11-13。</li>
</ul>
<h5 id="电子邮件地址"><a href="#电子邮件地址" class="headerlink" title="电子邮件地址"></a>电子邮件地址</h5><ul>
<li><code>&quot;email&quot;</code>：互联网电子邮件地址，请参阅RFC 5322，第3.4.1节。</li>
<li><code>&quot;idn-email&quot;</code>：draft7中的新增功能Internet电子邮件地址的国际化形式，请参阅 RFC 6531。</li>
</ul>
<h5 id="主机名"><a href="#主机名" class="headerlink" title="主机名"></a>主机名</h5><ul>
<li><code>&quot;hostname&quot;</code>：Internet主机名，请参阅RFC 1034第3.1节。</li>
<li><code>&quot;idn-hostname&quot;</code>：draft7中的新增内容国际化的Internet主机名，请参阅 RFC5890第2.3.2.3节。</li>
</ul>
<h5 id="IP地址"><a href="#IP地址" class="headerlink" title="IP地址"></a>IP地址</h5><ul>
<li><code>&quot;ipv4&quot;</code>：IPv4地址，根据RFC 2673第3.2节中定义的点分四进制ABNF语法。</li>
<li><code>&quot;ipv6&quot;</code>：IPv6地址，如RFC 2373第2.2节中所定义。</li>
</ul>
<h5 id="资源标识符"><a href="#资源标识符" class="headerlink" title="资源标识符"></a>资源标识符</h5><ul>
<li><code>&quot;uri&quot;</code>：根据RFC3986的通用资源标识符（URI） 。</li>
<li><code>&quot;uri-reference&quot;</code>：draft6中的新增内容URI参考（URI或相对参考），根据RFC3986，第4.1节。</li>
<li><code>&quot;iri&quot;</code>：draft7中的新增内容，根据RFC3987，“ uri”的国际化等效项。</li>
<li><code>&quot;iri-reference&quot;</code>：draft7中的新增内容，根据RFC3987，“ uri-reference”的国际化等效项<br>如果Schema中的值具有相对于特定源路径（例如，来自网页的链接）的能力，则通常更好的做法是使用 “uri-reference”（或”iri-reference”）而不是”uri”（或 “iri”）。”uri”仅在路径必须为绝对路径时才应使用。</li>
</ul>
<h5 id="URI模板"><a href="#URI模板" class="headerlink" title="URI模板"></a>URI模板</h5><ul>
<li><code>&quot;uri-template&quot;</code>：draft6中的新内容根据RFC6570的URI模板（任何级别） 。如果您还不知道URI模板是什么，则可能不需要此值。</li>
</ul>
<h5 id="JSON指针"><a href="#JSON指针" class="headerlink" title="JSON指针"></a>JSON指针</h5><ul>
<li><code>&quot;json-pointer&quot;</code>：根据RFC6901 ，draft6 A JSON指针中的新增内容。在构造复杂的Schema时，将有更多关于JSON指针在JSONSchema中使用的讨论。请注意，仅当整个字符串仅包含JSON指针内容时，才应使用此属性 &#x2F;foo&#x2F;bar。JSON指针URI片段，例如#&#x2F;foo&#x2F;bar&#x2F;应使用 “uri-reference”。</li>
<li><code>&quot;relative-json-pointer&quot;</code>：draft7中的新增内容相对JSON指针。</li>
</ul>
<h5 id="正则表达式-1"><a href="#正则表达式-1" class="headerlink" title="正则表达式"></a>正则表达式</h5><ul>
<li><code>&quot;regex&quot;</code>：draft7中的新增内容一个正则表达式，根据ECMA 262 方言应有效。<blockquote>
<p>请注意，在实践中，JSON Schema验证器只需要接受本文档其他地方描述的正则表达式的安全子集。</p>
</blockquote>
</li>
</ul>
<h2 id="正则表达式-2"><a href="#正则表达式-2" class="headerlink" title="正则表达式"></a>正则表达式</h2><p><code>pattern</code>和<code>Pattern Properties</code>关键字使用正则表达式来表示约束。使用的正则表达式语法来自JavaScript（尤其是ECMA 262）。但是，<font color="red">不完全支持完整的语法，因此建议您坚持下面描述的该语法的子集</font>。</p>
<ul>
<li><code>单个unicode字符</code>（下面的特殊字符除外）与自己匹配。</li>
<li><code>.</code>：匹配除换行符以外的任何字符。（请注意，换行符的构成在某种程度上取决于您的平台和语言环境，但实际上这并不重要）。</li>
<li><code>^</code>：仅在字符串开头匹配。</li>
<li><code>$</code>：仅在字符串末尾匹配。</li>
<li><code>(...)</code>：将一系列正则表达式分组为一个正则表达式。</li>
<li><code>|</code>：匹配|符号之前或之后的正则表达式。</li>
<li><code>[abc]</code>：匹配方括号内的任何字符。</li>
<li><code>[a-z]</code>：匹配字符范围。</li>
<li><code>[^abc]</code>：匹配未列出的任何字符。</li>
<li><code>[^a-z]</code>：匹配范围之外的任何字符。</li>
<li><code>+</code>：匹配前一个正则表达式的一个或多个重复。</li>
<li><code>*</code>：匹配零个或多个前面的正则表达式重复。</li>
<li><code>?</code>：匹配前一个正则表达式的零个或一个重复。</li>
<li><code>+?</code>，<code>*?</code>，<code>??</code>：*，+和?都是贪婪的; 它们匹配尽可能多的文本。有时，这种行为是不希望的，并且您想要匹配的字符越少越好。</li>
<li><code>(?!x)</code>，<code>(?=x)</code>：是否匹配或者不匹配x字符。</li>
<li><code>&#123;x&#125;</code>：精确x匹配前面的正则表达式的出现。</li>
<li><code>&#123;x,y&#125;</code>：至少匹配x并且最多y匹配前面的正则表达式。</li>
<li><code>&#123;x,&#125;</code>：匹配x出现的一个或多个前面的正则表达式。</li>
<li><code>&#123;x&#125;?</code>，<code>&#123;x,y&#125;?</code>，<code>&#123;x,&#125;?</code>：上述表达式的惰性版本。</li>
</ul>
<h3 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h3><p>下面的示例将一个简单的北美电话号码与一个可选的区号进行匹配：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^(\\([0-9]&#123;3&#125;\\))?[0-9]&#123;3&#125;-[0-9]&#123;4&#125;$&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><figcaption><span>正确示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &quot;555-1212&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><figcaption><span>正确示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &quot;(888)555-1212&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><figcaption><span>错误示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &quot;(888)555-1212 ext. 532&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><figcaption><span>错误示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &quot;(800)FLOWERS&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="数值"><a href="#数值" class="headerlink" title="数值"></a>数值</h2><p>JSON Schema中有两种数字类型：<code>integer</code>和<code>number</code>。它们共享相同的验证关键字。</p>
<blockquote>
<p>JSON没有表示复数的标准方式，因此无法在JSON Schema中对其进行测试。</p>
</blockquote>
<h3 id="整数"><a href="#整数" class="headerlink" title="整数"></a>整数</h3><p><code>integer</code>类型用于整数。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 42</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ -1</span></span><br></pre></td></tr></table></figure>

<p>浮点数被拒绝：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- 3.1415926</span></span><br></pre></td></tr></table></figure>

<p>拒绝将数字作为字符串：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &quot;42&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：对“整数”类型的精确处理可能取决于JSON Schema验证程序的实现。JavaScript（以及JSON）没有整数和浮点值的不同类型。因此，JSON Schema不能单独使用类型来区分整数和非整数。JSON Schema规范建议（但不要求）验证者使用数学值确定数字是否为整数，而不是单独的类型。因此，在这一点上，验证者之间存在一些分歧。例如，基于JavaScript的验证器可以接受<code>1.0</code>为整数，而基于Python的<a target="_blank" rel="noopener" href="https://pypi.org/project/jsonschema/">jsonschema</a>不接受。</p>
</blockquote>
<p>可以巧妙地使用<code>multipleOf</code>关键字（请参见<a target="_blank" rel="noopener" href="https://json-schema.org/understanding-json-schema/reference/numeric.html#multiples">Multiples</a>）来避免这种差异。例如，以下可能在所有JSON Schema实现上具有相同的行为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;multipleOf&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 42</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 42.0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- 3.14156926</span></span><br></pre></td></tr></table></figure>

<h3 id="数字"><a href="#数字" class="headerlink" title="数字"></a>数字</h3><p><code>number</code>类型可用于任何数字类型，整数或浮点数。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 42</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ -1</span></span><br></pre></td></tr></table></figure>

<p>简单浮点数：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 5.0</span></span><br></pre></td></tr></table></figure>

<p>指数表示法也适用：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 2.99792458e8</span></span><br></pre></td></tr></table></figure>

<p>不支持将数字作为字符串：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &quot;42&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="倍数"><a href="#倍数" class="headerlink" title="倍数"></a>倍数</h3><p>使用<code>multipleOf</code>关键字可以将数字限制为给定数字的倍数 。可以将其设置为任何正数。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span>       <span class="punctuation">:</span> <span class="string">&quot;number&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;multipleOf&quot;</span> <span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 10</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 20</span></span><br></pre></td></tr></table></figure>

<p>不是10的倍数：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- 23</span></span><br></pre></td></tr></table></figure>

<h3 id="范围"><a href="#范围" class="headerlink" title="范围"></a>范围</h3><p>数字范围是使用<code>minimum</code>和<code>maximum</code>关键字（或<code>exclusiveMinimum</code>和<code>exclusiveMaximum</code>用于表示互斥范围）的组合来指定的 。<br>如果x是要验证的值，则以下条件必须为true：</p>
<ul>
<li>x ≥minimum</li>
<li>x &gt;exclusiveMinimum</li>
<li>x ≤maximum</li>
<li>x &lt;exclusiveMaximum</li>
</ul>
<p>虽然你可以同时指定的minimum和exclusiveMinimum，或者同时指定 maximum和exclusiveMaximum，但这样做没有多大意义。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;minimum&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;exclusiveMaximum&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>少于minimum：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- -1</span></span><br></pre></td></tr></table></figure>

<p>minimum 包含在内，因此0有效：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 10</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 99</span></span><br></pre></td></tr></table></figure>

<p>exclusiveMaximum 是排他性的，因此100无效：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- 100</span></span><br></pre></td></tr></table></figure>

<p>大于maximum：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- 101</span></span><br></pre></td></tr></table></figure>

<h2 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h2><p><code>object</code>是JSON中的映射类型(mapping)。他们将“key”映射到“value”。在JSON中，“key”必须始终为字符串。这些KV对中的每一对通常都称为“属性”。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123;</span></span><br><span class="line"><span class="addition">+    &quot;key&quot;         : &quot;value&quot;,</span></span><br><span class="line"><span class="addition">+    &quot;another_key&quot; : &quot;another_value&quot;</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123;</span></span><br><span class="line"><span class="addition">+     &quot;Sun&quot;     : 1.9891e30,</span></span><br><span class="line"><span class="addition">+     &quot;Jupiter&quot; : 1.8986e27,</span></span><br><span class="line"><span class="addition">+     &quot;Saturn&quot;  : 5.6846e26,</span></span><br><span class="line"><span class="addition">+     &quot;Neptune&quot; : 10.243e25,</span></span><br><span class="line"><span class="addition">+     &quot;Uranus&quot;  : 8.6810e25,</span></span><br><span class="line"><span class="addition">+     &quot;Earth&quot;   : 5.9736e24,</span></span><br><span class="line"><span class="addition">+     &quot;Venus&quot;   : 4.8685e24,</span></span><br><span class="line"><span class="addition">+     &quot;Mars&quot;    : 6.4185e23,</span></span><br><span class="line"><span class="addition">+     &quot;Mercury&quot; : 3.3022e23,</span></span><br><span class="line"><span class="addition">+     &quot;Moon&quot;    : 7.349e22,</span></span><br><span class="line"><span class="addition">+     &quot;Pluto&quot;   : 1.25e22</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br></pre></td></tr></table></figure>

<p>使用非字符串作为键是无效的JSON：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123;</span></span><br><span class="line"><span class="deletion">-     0.01 : &quot;cm&quot;</span></span><br><span class="line"><span class="deletion">-     1    : &quot;m&quot;,</span></span><br><span class="line"><span class="deletion">-     1000 : &quot;km&quot;</span></span><br><span class="line"><span class="deletion">- &#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &quot;Not an object&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- [&quot;An&quot;, &quot;array&quot;, &quot;not&quot;, &quot;an&quot;, &quot;object&quot;]</span></span><br></pre></td></tr></table></figure>

<h3 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h3><p><code>properties</code>关键字定义对象上的属性（键值对KV）。properties的value是一个对象，其中每个键是属性的名称，每个值是用于验证该属性的JSON Schema。<br>例如，假设我们要为由数字，街道名称和街道类型组成的地址定义一个简单的Schema：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span>      <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;street_name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;street_type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                     <span class="attr">&quot;enum&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Street&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Avenue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Boulevard&quot;</span><span class="punctuation">]</span></span><br><span class="line">                   <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123; &quot;number&quot;: 1600, &quot;street_name&quot;: &quot;Pennsylvania&quot;, &quot;street_type&quot;: &quot;Avenue&quot; &#125;</span></span><br></pre></td></tr></table></figure>

<p>如果我们提供的电话号码类型错误，则该号码无效：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123; &quot;number&quot;: &quot;1600&quot;, &quot;street_name&quot;: &quot;Pennsylvania&quot;, &quot;street_type&quot;: &quot;Avenue&quot; &#125;</span></span><br></pre></td></tr></table></figure>

<p>默认情况下，忽略属性是有效的。请参阅 必需的属性。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123; &quot;number&quot;: 1600, &quot;street_name&quot;: &quot;Pennsylvania&quot; &#125;</span></span><br></pre></td></tr></table></figure>

<p>通过扩展，即使是空对象也有效：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &#125;</span><br></pre></td></tr></table></figure>

<p>默认情况下，提供其他属性是有效的：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123;</span></span><br><span class="line"><span class="addition">+     &quot;number&quot;:1600,</span></span><br><span class="line"><span class="addition">+     &quot;street_name&quot;:&quot;Pennsylvania&quot;,</span></span><br><span class="line"><span class="addition">+     &quot;street_type&quot;:&quot;Avenue&quot;,</span></span><br><span class="line"><span class="addition">+     &quot;direction&quot;:&quot;NW&quot;</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="额外的属性"><a href="#额外的属性" class="headerlink" title="额外的属性"></a>额外的属性</h3><p><code>additionalProperties</code>关键字用于控制的额外的属性，也就是说，属性的名称没有在 properties关键字中列出的。默认情况下，允许任何其他属性。<br>additionalProperties关键字可以是一个布尔值或对象。如果additionalProperties为boolean并将其设置为false，则不允许使用其他属性。<br>重用上面的示例，但是这次将设置 additionalProperties为false。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span>      <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;street_name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;street_type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                     <span class="attr">&quot;enum&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Street&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Avenue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Boulevard&quot;</span><span class="punctuation">]</span></span><br><span class="line">                   <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;additionalProperties&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123; &quot;number&quot;: 1600, &quot;street_name&quot;: &quot;Pennsylvania&quot;, &quot;street_type&quot;: &quot;Avenue&quot; &#125;</span></span><br></pre></td></tr></table></figure>

<p>由于additionalPropertiesis false，所以这个额外的属性“ direction”使对象无效：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123;</span></span><br><span class="line"><span class="deletion">-     &quot;number&quot;:1600,</span></span><br><span class="line"><span class="deletion">-     &quot;street_name&quot;:&quot;Pennsylvania&quot;,</span></span><br><span class="line"><span class="deletion">-     &quot;street_type&quot;:&quot;Avenue&quot;,</span></span><br><span class="line"><span class="deletion">-     &quot;direction&quot;:&quot;NW&quot;</span></span><br><span class="line"><span class="deletion">- &#125;</span></span><br></pre></td></tr></table></figure>

<p>如果additionalProperties是对象，则该对象是将用于验证未在properties中列出的任何其他属性的Schema。<br>例如，可以允许其他属性，但前提是每个属性都是一个字符串：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span>      <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;street_name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;street_type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                     <span class="attr">&quot;enum&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Street&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Avenue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Boulevard&quot;</span><span class="punctuation">]</span></span><br><span class="line">                   <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;additionalProperties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123; &quot;number&quot;: 1600, &quot;street_name&quot;: &quot;Pennsylvania&quot;, &quot;street_type&quot;: &quot;Avenue&quot; &#125;</span></span><br></pre></td></tr></table></figure>

<p>这是有效的，因为附加属性的值是一个字符串：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123;</span></span><br><span class="line"><span class="addition">+     &quot;number&quot;:1600,</span></span><br><span class="line"><span class="addition">+     &quot;street_name&quot;:&quot;Pennsylvania&quot;,</span></span><br><span class="line"><span class="addition">+     &quot;street_type&quot;:&quot;Avenue&quot;,</span></span><br><span class="line"><span class="addition">+     &quot;direction&quot;:&quot;NW&quot;</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br></pre></td></tr></table></figure>

<p>这是无效的，因为附加属性的值不是字符串：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123;</span></span><br><span class="line"><span class="deletion">-     &quot;number&quot;:1600,</span></span><br><span class="line"><span class="deletion">-     &quot;street_name&quot;:&quot;Pennsylvania&quot;,</span></span><br><span class="line"><span class="deletion">-     &quot;street_type&quot;:&quot;Avenue&quot;,</span></span><br><span class="line"><span class="deletion">-     &quot;office_number&quot;:201</span></span><br><span class="line"><span class="deletion">- &#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="必需的属性"><a href="#必需的属性" class="headerlink" title="必需的属性"></a>必需的属性</h3><p>默认情况下，<code>properties</code>关键字定义的属性并不是必需的。但是，可以使用required关键字限制必需属性的列表。<br><code>required</code>关键字支持零个或多个字符串的数组。这些字符串中的每一个都必须是唯一的。<br>在以下定义用户记录的示例Schema中，我们要求每个用户都有一个姓名和电子邮件地址，但是我们不介意他们是否不提供其地址或电话号码：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span>      <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span>     <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span>   <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;telephone&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">,</span> <span class="string">&quot;email&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123;</span></span><br><span class="line"><span class="addition">+   &quot;name&quot;: &quot;William Shakespeare&quot;,</span></span><br><span class="line"><span class="addition">+   &quot;email&quot;: &quot;bill@stratford-upon-avon.co.uk&quot;</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br></pre></td></tr></table></figure>

<p>即使在Schema中未定义属性，也可以提供额外的属性：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123;</span></span><br><span class="line"><span class="addition">+   &quot;name&quot;: &quot;William Shakespeare&quot;,</span></span><br><span class="line"><span class="addition">+   &quot;email&quot;: &quot;bill@stratford-upon-avon.co.uk&quot;,</span></span><br><span class="line"><span class="addition">+   &quot;address&quot;: &quot;Henley Street, Stratford-upon-Avon, Warwickshire, England&quot;,</span></span><br><span class="line"><span class="addition">+   &quot;authorship&quot;: &quot;in question&quot;</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br></pre></td></tr></table></figure>

<p>缺少必需的“email”属性会使JSON文档无效：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123;</span></span><br><span class="line"><span class="deletion">-   &quot;name&quot;: &quot;William Shakespeare&quot;,</span></span><br><span class="line"><span class="deletion">-   &quot;address&quot;: &quot;Henley Street, Stratford-upon-Avon, Warwickshire, England&quot;,</span></span><br><span class="line"><span class="deletion">- &#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="属性名称"><a href="#属性名称" class="headerlink" title="属性名称"></a>属性名称</h3><blockquote>
<p>draft6的新功能</p>
</blockquote>
<p>可以根据Schema验证属性的名称，而不管其值如何。如果您不想强制使用特定的属性，但是要确保这些属性的名称遵循特定的约定，这将很有用。例如，您可能想要强制所有名称都是有效的ASCII令牌，以便可以将它们用作特定编程语言中的属性。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;propertyNames&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^[A-Za-z_][A-Za-z0-9_]*$&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123;</span></span><br><span class="line"><span class="addition">+   &quot;_a_proper_token_001&quot;: &quot;value&quot;</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123;</span></span><br><span class="line"><span class="deletion">-   &quot;001 invalid&quot;: &quot;value&quot;</span></span><br><span class="line"><span class="deletion">- &#125;</span></span><br></pre></td></tr></table></figure>

<p>由于对象键无论如何都必须始终是字符串，因此暗示所赋予的模式propertyNames至少始终是：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Size"><a href="#Size" class="headerlink" title="Size"></a>Size</h3><p>可以使用<code>minProperties</code>和<code>maxProperties</code>关键字限制对象上的属性数量 。每个参数都必须是非负整数。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;minProperties&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;maxProperties&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123;&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123; &quot;a&quot;: 0 &#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123; &quot;a&quot;: 0, &quot;b&quot;: 1 &#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123; &quot;a&quot;: 0, &quot;b&quot;: 1, &quot;c&quot;: 2 &#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123; &quot;a&quot;: 0, &quot;b&quot;: 1, &quot;c&quot;: 2, &quot;d&quot;: 3 &#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><blockquote>
<p>这是JSON模式的高级功能。</p>
</blockquote>
<p><code>dependencies</code>关键字允许基于某些特殊属性而改变对象Schema。<br>JSON Schema中有两种形式的依赖关系：</p>
<ul>
<li><strong>property依赖</strong>声明如果存在给定的属性，则必须存在某些其他属性。</li>
<li><strong>schema依赖</strong>声明存在给定属性时Schema会更改。</li>
</ul>
<h4 id="property依赖"><a href="#property依赖" class="headerlink" title="property依赖"></a>property依赖</h4><p>让我们从property依赖的简单情况开始。例如，假设我们有一个表示客户的Schema。如果您有他们的信用卡号，则还需要确保您有帐单地址。如果您没有他们的信用卡号，则不需要帐单地址。我们使用dependencies关键字表示一个属性对另一个属性的依赖。<code>dependencies</code>关键字的值是一个对象。对象中的每个条目都从属性名p映射到列出存在p时所需的属性的字符串数组。<br>在下面的示例中，每当提供credit_card属性时，billing_address也必须存在一个属性：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;credit_card&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;billing_address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;credit_card&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;billing_address&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123;</span></span><br><span class="line"><span class="addition">+   &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="addition">+   &quot;credit_card&quot;: 5555555555555555,</span></span><br><span class="line"><span class="addition">+   &quot;billing_address&quot;: &quot;555 Debtor&#x27;s Lane&quot;</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br></pre></td></tr></table></figure>

<p>此实例有个credit_card，但缺少个 billing_address。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123;</span></span><br><span class="line"><span class="deletion">-   &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="deletion">-   &quot;credit_card&quot;: 5555555555555555</span></span><br><span class="line"><span class="deletion">- &#125;</span></span><br></pre></td></tr></table></figure>

<p>没关系，因为我们既没有a credit_card，也没有a billing_address。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123;</span></span><br><span class="line"><span class="addition">+   &quot;name&quot;: &quot;John Doe&quot;</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br></pre></td></tr></table></figure>

<p>请注意，依赖性不是双向的。没有信用卡号的帐单地址也可以。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123;</span></span><br><span class="line"><span class="addition">+   &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="addition">+   &quot;billing_address&quot;: &quot;555 Debtor&#x27;s Lane&quot;</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br></pre></td></tr></table></figure>

<p>要解决以上最后一个问题（依赖性不是双向的），您当然可以明确定义双向依赖性：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;credit_card&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;billing_address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;credit_card&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;billing_address&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;billing_address&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;credit_card&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>此实例有个credit_card，但缺少个 billing_address。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123;</span></span><br><span class="line"><span class="deletion">-   &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="deletion">-   &quot;credit_card&quot;: 5555555555555555</span></span><br><span class="line"><span class="deletion">- &#125;</span></span><br></pre></td></tr></table></figure>

<p>这有一个billing_address，但缺少一个 credit_card。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123;</span></span><br><span class="line"><span class="deletion">-   &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="deletion">-   &quot;billing_address&quot;: &quot;555 Debtor&#x27;s Lane&quot;</span></span><br><span class="line"><span class="deletion">- &#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="schema依赖"><a href="#schema依赖" class="headerlink" title="schema依赖"></a>schema依赖</h4><p>schema依赖的工作方式类似于属性依赖项，但是它们不仅可以指定其他必需的属性，还可以扩展schema使其具有其他约束。<br>例如，这是编写以上内容的另一种方法：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;credit_card&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;credit_card&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;billing_address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;billing_address&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123;</span></span><br><span class="line"><span class="addition">+   &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="addition">+   &quot;credit_card&quot;: 5555555555555555,</span></span><br><span class="line"><span class="addition">+   &quot;billing_address&quot;: &quot;555 Debtor&#x27;s Lane&quot;</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br></pre></td></tr></table></figure>

<p>该实例具有credit_card，但缺少 billing_address：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123;</span></span><br><span class="line"><span class="deletion">-   &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="deletion">-   &quot;credit_card&quot;: 5555555555555555</span></span><br><span class="line"><span class="deletion">- &#125;</span></span><br></pre></td></tr></table></figure>

<p>这有一个billing_address，但缺少一个 credit_card。这通过了，因为这里billing_address 看起来像是一个附加属性：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123;</span></span><br><span class="line"><span class="addition">+   &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="addition">+   &quot;billing_address&quot;: &quot;555 Debtor&#x27;s Lane&quot;</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Pattern属性"><a href="#Pattern属性" class="headerlink" title="Pattern属性"></a>Pattern属性</h3><p>如上所述，<code>additionalProperties</code>可以限制对象，使其不允许未明确列出的其他属性，或者可以为对象上的任何其他属性指定Schema。有时这还不够，您可能想限制额外属性的名称，或者您可能想说，给定特定种类的名称，该值应与特定模式匹配。这就需要<code>patternProperties</code>：这是一个新关键字，它从正则表达式映射到Schema。如果其他属性与给定的正则表达式匹配，则还必须针对相应的模式进行验证。</p>
<blockquote>
<p>在定义正则表达式时，请务必注意，表达式可以在属性名称中的任何位置匹配。例如，正则表达式”p”将匹配其中包含任何属性的名称p，例如”apple”，而不仅仅是名称简单的属性”p”。它因此比较混乱包围在正则表达式^…$，例如”^p$”。</p>
</blockquote>
<p>在此示例中，任何名称以前缀开头的其他属性都<code>S_</code>必须是字符串，而任何以前缀开头的属性都<code>I_</code>必须是整数。<code>properties</code>也接受在关键字中明确定义的任何属性，并且禁止与这两个正则表达式都不匹配的任何其他属性。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;patternProperties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;^S_&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;^I_&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;additionalProperties&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123; &quot;S_25&quot;: &quot;This is a string&quot; &#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123; &quot;I_0&quot;: 42 &#125;</span></span><br></pre></td></tr></table></figure>
<p>如果名称以开头S_，则必须为字符串</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123; &quot;S_0&quot;: 42 &#125;</span></span><br></pre></td></tr></table></figure>
<p>如果名称以开头I_，则必须为整数</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123; &quot;I_42&quot;: &quot;This is a string&quot; &#125;</span></span><br></pre></td></tr></table></figure>
<p>这是一个与任何正则表达式都不匹配的键：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123; &quot;keyword&quot;: &quot;value&quot; &#125;</span></span><br></pre></td></tr></table></figure>

<p><code>patternProperties</code>可以与结合使用<code>additionalProperties</code>。在这种情况下，additionalProperties将引用未在其中明确列出properties且与中的任何一个都不匹配的任何属性 patternProperties。在下面的示例中，基于上述内容，我们添加了一个”builtin” 属性，该属性必须是数字，并声明所有其他属性（既不是内置属性也不由匹配 patternProperties）都必须是字符串：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;builtin&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;patternProperties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;^S_&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;^I_&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;additionalProperties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123; &quot;builtin&quot;: 42 &#125;</span></span><br></pre></td></tr></table></figure>

<p>这是一个与任何正则表达式都不匹配的键：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123; &quot;keyword&quot;: &quot;value&quot; &#125;</span></span><br></pre></td></tr></table></figure>

<p>它必须是一个字符串：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123; &quot;keyword&quot;: 42 &#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><p>数组用于有序元素。在JSON中，数组中的每个元素都可以具有不同的类型。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ [1, 2, 3, 4, 5]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ [3, &quot;different&quot;, &#123; &quot;types&quot; : &quot;of values&quot; &#125;]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123;&quot;Not&quot;: &quot;an array&quot;&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Items"><a href="#Items" class="headerlink" title="Items"></a>Items</h3><p>默认情况下，数组的元素可以是任何东西。但是，通常也可以根据某种Schema来验证数组的元素，也就是<code>items</code>， <code>additionalItems</code>和<code>contains</code>关键字。<br>JSON中通常使用两种方式使用数组：</p>
<ul>
<li><strong>列表验证</strong>：任意长度的序列，其中每个项目都匹配相同的Schema。</li>
<li><strong>元组验证</strong>：固定长度的序列，其中每个项目可能具有不同的Schema。在这种用法中，每个项目的索引（或位置）对于如何解释该值都是有意义的。（这种用法通常在某些编程语言（例如Python的语言）中被赋予一种完全独立的类型<code>tuple</code>）。</li>
</ul>
<h4 id="列表验证"><a href="#列表验证" class="headerlink" title="列表验证"></a>列表验证</h4><p>列表验证<strong>List Validation</strong>对于其中每个元素都匹配相同Schema的任意长度的数组很有用。对于这种数组，将<code>items</code>关键字设置为单个模式，该模式将用于验证数组中的所有项目。</p>
<blockquote>
<p>当<code>items</code>为single schema时，<code>additionalItems</code>关键字是没有意义的，因此不应使用。</p>
</blockquote>
<p>在下面的示例中，我们定义数组中的每个项目都是一个数字：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ [1, 2, 3, 4, 5]</span></span><br></pre></td></tr></table></figure>

<p>单个“非数字”会导致整个数组无效：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- [1, 2, &quot;3&quot;, 4, 5]</span></span><br></pre></td></tr></table></figure>

<p>空数组始终有效：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ []</span></span><br></pre></td></tr></table></figure>

<p>尽管items schema必须对数组中的每个元素都有效，但是 contains schema仅需要针对数组中的一个或多个元素进行验证。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;contains&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>一个“数字”就足以通过此认证：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ [&quot;life&quot;, &quot;universe&quot;, &quot;everything&quot;, 42]</span></span><br></pre></td></tr></table></figure>

<p>但是，如果我们没有数字，它将失败：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- [&quot;life&quot;, &quot;universe&quot;, &quot;everything&quot;, &quot;forty-two&quot;]</span></span><br></pre></td></tr></table></figure>

<p>当然，所有数字都还可以：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ [1, 2, 3, 4, 5]</span></span><br></pre></td></tr></table></figure>

<h4 id="元组验证"><a href="#元组验证" class="headerlink" title="元组验证"></a>元组验证</h4><p>当数组是元素的集合时，其中每个元素具有不同的schema并且每个项目的序号索引都有意义，则元组验证<strong>Tuple Validation</strong>很有用。<br>例如，您可以代表街道地址<br><code>1600 Pennsylvania Avenue NW</code></p>
<p>作为以下形式的4元组：<br><code>[数字，街道名称，街道类型，方向]</code><br>这些字段中的每个字段将具有不同的schema：</p>
<ul>
<li><code>number</code>：地址号码。必须是数字。</li>
<li><code>street_name</code>：街道名称。必须是一个字符串。</li>
<li><code>street_type</code>：街道类型。应该是来自一组固定值的字符串。</li>
<li><code>direction</code>：地址的城市象限。应该是来自一组不同值的字符串。</li>
</ul>
<p>为此，我们将items关键字设置为一个数组，其中每个项目都是一个与文档数组的每个索引相对应的Schema。也就是说，其中第一个元素验证输入数组的第一个元素，第二个元素验证输入数组的第二个元素的数组，依此类推。<br>这是示例Schema：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;enum&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Street&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Avenue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Boulevard&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;enum&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;NW&quot;</span><span class="punctuation">,</span> <span class="string">&quot;NE&quot;</span><span class="punctuation">,</span> <span class="string">&quot;SW&quot;</span><span class="punctuation">,</span> <span class="string">&quot;SE&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ [1600, &quot;Pennsylvania&quot;, &quot;Avenue&quot;, &quot;NW&quot;]</span></span><br></pre></td></tr></table></figure>

<p>“驾车”不是可接受的街道类型之一：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- [24, &quot;Sussex&quot;, &quot;Drive&quot;]</span></span><br></pre></td></tr></table></figure>

<p>该地址缺少街道号码</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- [&quot;Palais de l&#x27;Élysée&quot;]</span></span><br></pre></td></tr></table></figure>

<p>可以不提供所有项目：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ [10, &quot;Downing&quot;, &quot;Street&quot;]</span></span><br></pre></td></tr></table></figure>

<p>而且，默认情况下，也可以添加其他项目作为结尾：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ [1600, &quot;Pennsylvania&quot;, &quot;Avenue&quot;, &quot;NW&quot;, &quot;Washington&quot;]</span></span><br></pre></td></tr></table></figure>

<p><code>additionalItems</code>关键字控制是否有效有超出了所定义的数组中的其他项目items。在这里，我们将重用上面的示例Schema，但是将其设置additionalItems为false，其效果是不允许在数组中添加额外的项目。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;enum&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Street&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Avenue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Boulevard&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;enum&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;NW&quot;</span><span class="punctuation">,</span> <span class="string">&quot;NE&quot;</span><span class="punctuation">,</span> <span class="string">&quot;SW&quot;</span><span class="punctuation">,</span> <span class="string">&quot;SE&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;additionalItems&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ [1600, &quot;Pennsylvania&quot;, &quot;Avenue&quot;, &quot;NW&quot;]</span></span><br></pre></td></tr></table></figure>

<p>可以不提供所有项目：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ [1600, &quot;Pennsylvania&quot;, &quot;Avenue&quot;]</span></span><br></pre></td></tr></table></figure>

<p>但是，由于additionalItems是false，我们无法支持额外的元素：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- [1600, &quot;Pennsylvania&quot;, &quot;Avenue&quot;, &quot;NW&quot;, &quot;Washington&quot;]</span></span><br></pre></td></tr></table></figure>

<p><code>additionalItems</code>关键字也可以是一个Schema，用于对数组中的每个额外元素进行验证。在这种情况下，我们可以说允许额外元素，只要它们都是字符串即可：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;enum&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Street&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Avenue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Boulevard&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;enum&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;NW&quot;</span><span class="punctuation">,</span> <span class="string">&quot;NE&quot;</span><span class="punctuation">,</span> <span class="string">&quot;SW&quot;</span><span class="punctuation">,</span> <span class="string">&quot;SE&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;additionalItems&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>多余的字符串元素验证通过。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ [1600, &quot;Pennsylvania&quot;, &quot;Avenue&quot;, &quot;NW&quot;, &quot;Washington&quot;]</span></span><br></pre></td></tr></table></figure>

<p>但是非字符串就不行了</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- [1600, &quot;Pennsylvania&quot;, &quot;Avenue&quot;, &quot;NW&quot;, 20500]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>additionalItems</code>如果您正在执行“列表验证”（items是一个object对象），则没有任何意义，在这种情况下将被忽略。</p>
</blockquote>
<h3 id="Length"><a href="#Length" class="headerlink" title="Length"></a>Length</h3><p>可以使用<code>minItems</code>和<code>maxItems</code>关键字指定数组的长度。每个关键字的值必须为非负数。无论执行列表验证还是元组验证，这些关键字都有效。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;minItems&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;maxItems&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- []</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- [1]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ [1, 2]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ [1, 2, 3]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- [1, 2, 3, 4]</span></span><br></pre></td></tr></table></figure>
<h3 id="唯一"><a href="#唯一" class="headerlink" title="唯一"></a>唯一</h3><p>模式可以确保数组中的每个项目都是唯一的。只需将<code>uniqueItems</code>关键字设置为即可<code>true</code>。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;uniqueItems&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ [1, 2, 3, 4, 5]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- [1, 2, 3, 3, 4]</span></span><br></pre></td></tr></table></figure>
<p>空数组总是通过：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ []</span></span><br></pre></td></tr></table></figure>

<h2 id="布尔"><a href="#布尔" class="headerlink" title="布尔"></a>布尔</h2><p>布尔类型仅匹配两个特殊值：<code>true</code>和<code>false</code>。请注意，Schema不接受计算为true或的值false（例如1和0）。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;boolean&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ true</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ false</span></span><br></pre></td></tr></table></figure>

<p>不支持字符串</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &quot;true&quot;</span></span><br></pre></td></tr></table></figure>

<p>评估为true或false的值</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- 0</span></span><br></pre></td></tr></table></figure>

<p>不支持大写</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- TRUE</span></span><br></pre></td></tr></table></figure>

<h2 id="空"><a href="#空" class="headerlink" title="空"></a>空</h2><p>当Schema指定type为<code>null</code>时，它只有一个可接受的值：null。<br><strong>笔记</strong><br>重要的是要记住，在JSON中，null这并不等同于缺少某些内容。有关示例，请参见<a target="_blank" rel="noopener" href="https://json-schema.org/understanding-json-schema/reference/object.html#required">必需的属性</a>。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ null</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- false</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- 0</span></span><br></pre></td></tr></table></figure>
<p>空串也不行</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &quot;&quot;</span></span><br></pre></td></tr></table></figure>
<p>NULL也不行</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- </span></span><br></pre></td></tr></table></figure>

<h2 id="通用关键字"><a href="#通用关键字" class="headerlink" title="通用关键字"></a>通用关键字</h2><p>本章列出了一些可用于所有JSON类型的其他属性。</p>
<h3 id="注解Annotations"><a href="#注解Annotations" class="headerlink" title="注解Annotations"></a>注解Annotations</h3><p>JSON模式包含一些关键字，这些关键字并非严格用于验证，而是用于描述模式的各个部分。这些“注释”关键字都不是必需的，但鼓励您进行良好的实践，它们可以使您的模式“<strong>自我描述</strong>”。<br>在<code>title</code>和<code>description</code>关键字必须是字符串。“标题”将优选为简短的，而“描述”将提供有关该模式描述的数据的目的的更冗长的解释。<br><code>default</code>关键字指定一个默认值。在验证过程中，不会使用此值来填写缺少的值。非验证工具（例如文档生成器或表单生成器）可能会使用此值来向用户提示如何使用该值。但是，default通常用于表示如果缺少某个值，则该值在语义上与该值存在默认值时相同。default 应针对其所在的Schema进行验证，但这不是必需的。<br>draft6中的新增内容。<code>examples</code>关键字是用于提供一系列针对该Schema进行验证的示例。这不用于验证，但是可以帮助向读者解释该Schema的效果和目的。每个条目都应根据其所在的Schema进行验证，但这不是严格要求的。不需要在examples数组复制default值，因为default将作为另一个示例。<br>draft7中的新增内容。布尔关键字<code>readOnly</code>，<code>writeOnly</code>通常在API上下文中使用。readOnly指示不应修改值。它可以用来指示更改某个值的PUT请求将导致400 Bad request响应。writeOnly表示可以设置一个值，但将保持隐藏状态。writeOnly可以用来表示您可以在请求中设置一个值，但是不要通过GET请求检索该记录。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Match anything&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;This is a schema that matches anything.&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;default&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Default value&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;examples&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;Anything&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="number">4035</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;readOnly&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;writeOnly&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="注释Comments"><a href="#注释Comments" class="headerlink" title="注释Comments"></a>注释Comments</h3><blockquote>
<p>draft7的新功能<code>$comment</code></p>
</blockquote>
<p><code>$comment</code>关键字是严格用于向Schema添加注释。它的值必须始终是一个字符串。与注解title，description和examples不同，JSON模式实现不允许在其上附加任何含义或行为，甚至可以随时剥离它们。因此，它们对于将注释留给JSON模式的未来编辑者很有用，但不应用于与模式用户进行通信。</p>
<h3 id="枚举值"><a href="#枚举值" class="headerlink" title="枚举值"></a>枚举值</h3><p><code>enum</code>关键字被用于限制值，以一个固定的一组值。它必须是一个至少包含一个元素的数组，其中每个元素都是唯一的。<br>以下是验证路灯颜色的示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;enum&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;red&quot;</span><span class="punctuation">,</span> <span class="string">&quot;amber&quot;</span><span class="punctuation">,</span> <span class="string">&quot;green&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &quot;red&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &quot;blue&quot;</span></span><br></pre></td></tr></table></figure>

<p><code>enum</code>甚至可以不依赖type就可以支持不同类型的值。让我们扩展示例以null表示“ off”，并添加42，只是为了好玩。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;enum&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;red&quot;</span><span class="punctuation">,</span> <span class="string">&quot;amber&quot;</span><span class="punctuation">,</span> <span class="string">&quot;green&quot;</span><span class="punctuation">,</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span> <span class="number">42</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &quot;red&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ null</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 42</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- 0</span></span><br></pre></td></tr></table></figure>

<h3 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h3><blockquote>
<p>draft6的新功能</p>
</blockquote>
<p><code>const</code>关键字被用于限制值，必须是单一的值。<br>例如，如果您仅出于出口原因支持运送到美国：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;country&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;const&quot;</span><span class="punctuation">:</span> <span class="string">&quot;United States of America&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123; &quot;country&quot;: &quot;United States of America&quot; &#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123; &quot;country&quot;: &quot;Canada&quot; &#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Media：字符串编码的非JSON数据"><a href="#Media：字符串编码的非JSON数据" class="headerlink" title="Media：字符串编码的非JSON数据"></a>Media：字符串编码的非JSON数据</h2><blockquote>
<p>draft7的新功能</p>
</blockquote>
<p>JSON Schema具有一组关键字来描述和可选地验证存储在JSON字符串中的非JSON数据。由于很难为多种媒体类型编写验证器，因此不需要JSON模式验证器来基于这些关键字验证JSON字符串的内容。但是，这些关键字对于使用经过验证的JSON的应用程序仍然有用。</p>
<h3 id="contentMediaType"><a href="#contentMediaType" class="headerlink" title="contentMediaType"></a>contentMediaType</h3><p><code>contentMediaType</code>关键字指定的MIME类型的字符串的内容，如在RFC 2046。有一个IANA正式注册的MIME类型列表，但是受支持的类型集将取决于应用程序和操作系统。Mozilla开发人员网络还维护了一个<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Common_types">简短的MIME类型列表</a>。</p>
<h3 id="contentEncoding"><a href="#contentEncoding" class="headerlink" title="contentEncoding"></a>contentEncoding</h3><p><code>contentEncoding</code>关键字指定的编码用于存储内容，如在规定的RFC 2054，6.1部分。<br>可接受的值为<code>7bit</code>，<code>8bit</code>，<code>binary</code>，<code>quoted-printable</code>和<code>base64</code>。如果未指定，则编码与包含的JSON文档相同。<br>在不深入探讨每种编码的底层细节的情况下，实际上只有两个对现代用法有用的选项：</p>
<ul>
<li>如果内容的编码方式与随附的JSON文档相同（出于实际目的，几乎始终为UTF-8），则请保持 contentEncoding未指定状态，并将内容原样包含在字符串中。这包括基于文本的内容类型，例如text&#x2F;html或 application&#x2F;xml。</li>
<li>如果内容是二进制数据，请设置contentEncoding为base64并使用Base64对内容进行编码。这将包括许多图像类型，例如image&#x2F;png或音频类型，例如audio&#x2F;mpeg。</li>
</ul>
<h3 id="例子-2"><a href="#例子-2" class="headerlink" title="例子"></a>例子</h3><p>以下模式指示该字符串包含一个HTML文档，该HTML文档使用与周围文档相同的编码进行编码：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;contentMediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text/html&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &quot;&lt;!DOCTYPE html&gt;&lt;html xmlns=\&quot;http://www.w3.org/1999/xhtml\&quot;&gt;&lt;head&gt;&lt;/head&gt;&lt;/html&gt;&quot;</span></span><br></pre></td></tr></table></figure>

<p>以下Schema指示字符串包含使用Base64编码的PNG图像：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;contentEncoding&quot;</span><span class="punctuation">:</span> <span class="string">&quot;base64&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;contentMediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;image/png&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &quot;iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABmJLR0QA/wD/AP+gvaeTAAAA...&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="组合Schema"><a href="#组合Schema" class="headerlink" title="组合Schema"></a>组合Schema</h2><p>JSON Schema包括一些用于将Schema组合在一起的关键字。请注意，这不一定意味着组合必须来自多个文件或JSON的Schema，尽管这些功能有助于实现这一点，并且在<a target="_blank" rel="noopener" href="https://json-schema.org/understanding-json-schema/structuring.html#structuring">构建复杂的Schema</a>中对此进行了描述。组合Schema可能很简单，就像允许同时针对多个条件验证一个值一样简单。<br>例如，在以下模式中，<code>anyOf</code>关键字用于表示给定值可能针对任何给定子模式都是有效的。第一个子模式需要一个最大长度为5的字符串。第二个子模式需要一个最小值为0的数字。只要一个值针对这些模式中的任何一个进行验证，就被认为对整个组合模式都有效。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;anyOf&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;maxLength&quot;</span><span class="punctuation">:</span> <span class="number">5</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;minimum&quot;</span><span class="punctuation">:</span> <span class="number">0</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &quot;short&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &quot;too long&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 12</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- -5</span></span><br></pre></td></tr></table></figure>

<p>用于组合Schema的关键字为：</p>
<ul>
<li><code>allOf</code>：必须对所有子模式均有效</li>
<li><code>anyOf</code>：必须是至少一个子模式是有效的</li>
<li><code>oneOf</code>：必须对其中一种子模式有效<br>所有这些关键字都必须设置为一个数组，其中每个元素都是一个Schema。<br>此外，还有：</li>
<li><code>not</code>：必须不能是对给定的Schema是有效的</li>
</ul>
<h3 id="allOf"><a href="#allOf" class="headerlink" title="allOf"></a>allOf</h3><p>要针对进行验证<code>allOf</code>，给定的数据必须对所有给定的子模式都有效。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;allOf&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;maxLength&quot;</span><span class="punctuation">:</span> <span class="number">5</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &quot;short&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &quot;too long&quot;</span></span><br></pre></td></tr></table></figure>

<p>请注意，使用创建逻辑上不可能的模式非常容易allOf。下面的示例创建一个不会针对任何内容进行验证的Schema（因为某些内容不能同时为字符串和数字）：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;allOf&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &quot;No way&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- -1</span></span><br></pre></td></tr></table></figure>

<p>重要的是要注意，<code>allOf</code>，<code>anyOf</code> 或<code>oneOf</code>的数组中列出的Schema彼此之间一无所知。尽管可能令人惊讶，但是allOf不能用于“扩展”模式以从面向对象的继承的意义向其添加更多细节。例如，假设您在一个definitions部分中有一个地址模式，并且想要扩展它以包括地址类型：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;definitions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;street_address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span>           <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span>          <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;street_address&quot;</span><span class="punctuation">,</span> <span class="string">&quot;city&quot;</span><span class="punctuation">,</span> <span class="string">&quot;state&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;allOf&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/address&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;enum&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;residential&quot;</span><span class="punctuation">,</span> <span class="string">&quot;business&quot;</span> <span class="punctuation">]</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123;</span></span><br><span class="line"><span class="addition">+    &quot;street_address&quot;: &quot;1600 Pennsylvania Avenue NW&quot;,</span></span><br><span class="line"><span class="addition">+    &quot;city&quot;: &quot;Washington&quot;,</span></span><br><span class="line"><span class="addition">+    &quot;state&quot;: &quot;DC&quot;,</span></span><br><span class="line"><span class="addition">+    &quot;type&quot;: &quot;business&quot;</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br></pre></td></tr></table></figure>

<p>这行得通，但是如果我们想限制Schema以免其他属性被允许怎么办？您可以尝试在下面添加突出显示的行：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;definitions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;street_address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span>           <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span>          <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;street_address&quot;</span><span class="punctuation">,</span> <span class="string">&quot;city&quot;</span><span class="punctuation">,</span> <span class="string">&quot;state&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;allOf&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/address&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;enum&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;residential&quot;</span><span class="punctuation">,</span> <span class="string">&quot;business&quot;</span> <span class="punctuation">]</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;additionalProperties&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123;</span></span><br><span class="line"><span class="deletion">-    &quot;street_address&quot;: &quot;1600 Pennsylvania Avenue NW&quot;,</span></span><br><span class="line"><span class="deletion">-    &quot;city&quot;: &quot;Washington&quot;,</span></span><br><span class="line"><span class="deletion">-    &quot;state&quot;: &quot;DC&quot;,</span></span><br><span class="line"><span class="deletion">-    &quot;type&quot;: &quot;business&quot;</span></span><br><span class="line"><span class="deletion">- &#125;</span></span><br></pre></td></tr></table></figure>

<p><font color="red">不幸的是，现在该Schema将拒绝一切</font>。这是因为属性引用了整个Schema。整个Schema不包含任何属性，并且对allOf数组内部子模式中的属性一无所知。<br>这个缺点可能是JSON模式中合并操作的最大惊喜之一：它的行为不像面向对象语言中的继承。在下一个JSON模式规范版本中，有一些建议可以解决此问题。</p>
<h3 id="anyOf"><a href="#anyOf" class="headerlink" title="anyOf"></a>anyOf</h3><p>要针对进行验证<code>anyOf</code>，给定的数据必须针对任何（一个或多个）给定的子模式有效。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;anyOf&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &quot;Yes&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 42</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123; &quot;Not a&quot;: &quot;string or number&quot; &#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="oneOf"><a href="#oneOf" class="headerlink" title="oneOf"></a>oneOf</h3><p>为了针对进行验证<code>oneOf</code>，给定的数据必须对给定的子模式之一有效。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;oneOf&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;multipleOf&quot;</span><span class="punctuation">:</span> <span class="number">5</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;multipleOf&quot;</span><span class="punctuation">:</span> <span class="number">3</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 10</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 9</span></span><br></pre></td></tr></table></figure>

<p>不是5或3的倍数。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- 2</span></span><br></pre></td></tr></table></figure>

<p>5和3的倍数均被拒绝。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- 15</span></span><br></pre></td></tr></table></figure>

<p>注意，可以“分解”子模式的共同部分。以下Schema与上面的Schema等效：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;oneOf&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">     <span class="punctuation">&#123;</span> <span class="attr">&quot;multipleOf&quot;</span><span class="punctuation">:</span> <span class="number">5</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="punctuation">&#123;</span> <span class="attr">&quot;multipleOf&quot;</span><span class="punctuation">:</span> <span class="number">3</span> <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="not"><a href="#not" class="headerlink" title="not"></a>not</h3><p>这并不是严格地结合模式，但是它与其他有助于以某种方式修改Schame效果的内容都是属于本章。not关键字声明必须不满足给定的子模式。<br>例如，以下Schema针对不是字符串的任何内容进行验证：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;not&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 42</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123; &quot;key&quot;: &quot;value&quot; &#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &quot;I am a string&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="子模式条件判断"><a href="#子模式条件判断" class="headerlink" title="子模式条件判断"></a>子模式条件判断</h2><p>这里属于高阶用法，实践中不建议使用过于复杂的Schema。有兴趣可以访问<a target="_blank" rel="noopener" href="https://json-schema.org/understanding-json-schema/reference/conditionals.html">原文</a>。</p>
<h2 id="schema关键字"><a href="#schema关键字" class="headerlink" title="$schema关键字"></a>$schema关键字</h2><p><code>$schema</code>关键字被用于声明一个JSON片段实际上是一块JSON Schema的。它还声明了针对该Schema编写的JSON Schema标准版本。<br>建议所有JSON模式都<code>$schema</code>必须有一个条目，该条目必须位于根目录下。因此，在大多数情况下，您会希望这是Schema的根条目：<br><code>&quot;$schema&quot;: &quot;http://json-schema.org/draft/2019-09/schema#&quot;</code></p>
<blockquote>
<p>尽管官方建议显式声明schema版本，以便验证器知道使用何种版本校验。但实际我们在使用中统一使用draft7，即使声明了其他版本draft也会报错。所以<font color="blue">建议不声明$schema</font>。</p>
</blockquote>
<h1 id="构建复杂的Schema"><a href="#构建复杂的Schema" class="headerlink" title="构建复杂的Schema"></a>构建复杂的Schema</h1><p>当编写复杂程度适中的计算机程序时，通常认为将程序“结构化”为可重用的功能要好于在各处使用并复制和粘贴重复的代码。同样，在JSON模式中，对于除最琐碎的模式之外的任何内容，将模式结构化为可以在许多地方重用的部分非常有用。本章将提供一些实际示例，这些示例使用可用于重用和构建模式的工具。</p>
<h2 id="重用"><a href="#重用" class="headerlink" title="重用"></a>重用</h2><p>对于此示例，假设我们要定义一个客户记录，其中每个客户可能都具有送货地址和账单邮寄地址。地址始终是相同的-它们具有街道地址，城市和州名-因此我们不想在要存储地址的任何地方重复这部分Schema。这不仅会使Schema变得更加冗长，而且使将来的更新变得更加困难。如果我们假想的公司将来要开始从事国际业务，并且我们想在所有地址中添加一个国家&#x2F;地区字段，那么最好在一个地方而不是在所有使用地址的地方进行。<br>因此，让我们从定义地址的模式开始：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;street_address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span>           <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span>          <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;street_address&quot;</span><span class="punctuation">,</span> <span class="string">&quot;city&quot;</span><span class="punctuation">,</span> <span class="string">&quot;state&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>由于我们将重用此Schema，因此习惯上（但不是必需）将其放在父Schema下的键下<code>definitions</code>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;definitions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;street_address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span>           <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span>          <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;street_address&quot;</span><span class="punctuation">,</span> <span class="string">&quot;city&quot;</span><span class="punctuation">,</span> <span class="string">&quot;state&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>然后，我们可以使用<code>$ref</code>关键字从其他地方引用此模式片段 。描述的最简单方法<code>$ref</code>是，在逻辑上将其替换为它所指向的内容。因此，参考上面的内容，我们将包括：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/address&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以在任何需要模式的地方使用。您将始终将其<code>$ref</code>用作对象中的唯一键：验证器将忽略您放置在该对象中的任何其他键。<br><code>$ref</code>的值是URI引用，<code>#</code>符号后的部分（“片段”或“命名锚点”）采用称为JSON指针的格式。</p>
<blockquote>
<p>JSON指针旨在达到与XML世界中<a target="_blank" rel="noopener" href="https://www.w3.org/TR/xpath/">XPath</a>相同的目的，但是它要简单得多。</p>
</blockquote>
<p>如果您使用的是同一文档中的定义，则该$ref值以井号（#）开头。之后，以斜杠分隔的项目遍历文档中对象中的键。因此，在我们的示例中<code>&quot;#/definitions/address&quot;</code>意味着：</p>
<ol>
<li>转到文档的根</li>
<li>找到钥匙的价值<code>&quot;definitions&quot;</code></li>
<li>在该对象中，找到键的值<code>&quot;address&quot;</code><br>$ref可以解析为引用另一个文件的URI，因此，如果您希望将定义包括在单独的文件中，也可以这样做。例如：<br>{ “$ref”: “definitions.json#&#x2F;address” }</li>
</ol>
<p>会从与该地址同时存在的另一个文件中加载地址模式。</p>
<blockquote>
<p>目前实践中的Schema并非文件形式存储，这里的不可使用，仅允许使用文件内的引用。</p>
</blockquote>
<p>现在，我们将其放在一起，并使用我们的地址Schema为客户创建Schema：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://json-schema.org/draft-07/schema#&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;definitions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;street_address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span>           <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span>          <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;street_address&quot;</span><span class="punctuation">,</span> <span class="string">&quot;city&quot;</span><span class="punctuation">,</span> <span class="string">&quot;state&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;billing_address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/address&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;shipping_address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/address&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123;</span></span><br><span class="line"><span class="addition">+   &quot;shipping_address&quot;: &#123;</span></span><br><span class="line"><span class="addition">+     &quot;street_address&quot;: &quot;1600 Pennsylvania Avenue NW&quot;,</span></span><br><span class="line"><span class="addition">+     &quot;city&quot;: &quot;Washington&quot;,</span></span><br><span class="line"><span class="addition">+     &quot;state&quot;: &quot;DC&quot;</span></span><br><span class="line"><span class="addition">+   &#125;,</span></span><br><span class="line"><span class="addition">+   &quot;billing_address&quot;: &#123;</span></span><br><span class="line"><span class="addition">+     &quot;street_address&quot;: &quot;1st Street SE&quot;,</span></span><br><span class="line"><span class="addition">+     &quot;city&quot;: &quot;Washington&quot;,</span></span><br><span class="line"><span class="addition">+     &quot;state&quot;: &quot;DC&quot;</span></span><br><span class="line"><span class="addition">+   &#125;</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>即使<code>$ref</code>的值是URI引用，它也不是网络定位符，而只是一个标识符。这意味着不需要在解析的URI处访问Schema，但是可以。验证程序的实现基本上取决于验证程序的实现，但是不应假定验证程序将获取<code>$ref</code>值中指示的网络资源 。而<font color="blue">目前数据模型并不支持，所以这里不要使用</font>。</p>
</blockquote>
<h3 id="递归"><a href="#递归" class="headerlink" title="递归"></a>递归</h3><p><code>$ref</code>元素可用于创建引用自己的递归模式。例如，您可能有一个personSchema，其中包含的数组children，每个数组也是person实例。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://json-schema.org/draft-07/schema#&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;definitions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;person&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/person&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;default&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;person&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/person&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>英国王室家族的一小段</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123;</span></span><br><span class="line"><span class="addition">+   &quot;person&quot;: &#123;</span></span><br><span class="line"><span class="addition">+     &quot;name&quot;: &quot;Elizabeth&quot;,</span></span><br><span class="line"><span class="addition">+     &quot;children&quot;: [</span></span><br><span class="line"><span class="addition">+       &#123;</span></span><br><span class="line"><span class="addition">+         &quot;name&quot;: &quot;Charles&quot;,</span></span><br><span class="line"><span class="addition">+         &quot;children&quot;: [</span></span><br><span class="line"><span class="addition">+           &#123;</span></span><br><span class="line"><span class="addition">+             &quot;name&quot;: &quot;William&quot;,</span></span><br><span class="line"><span class="addition">+             &quot;children&quot;: [</span></span><br><span class="line"><span class="addition">+               &#123; &quot;name&quot;: &quot;George&quot; &#125;,</span></span><br><span class="line"><span class="addition">+               &#123; &quot;name&quot;: &quot;Charlotte&quot; &#125;</span></span><br><span class="line"><span class="addition">+             ]</span></span><br><span class="line"><span class="addition">+           &#125;,</span></span><br><span class="line"><span class="addition">+           &#123;</span></span><br><span class="line"><span class="addition">+             &quot;name&quot;: &quot;Harry&quot;</span></span><br><span class="line"><span class="addition">+           &#125;</span></span><br><span class="line"><span class="addition">+         ]</span></span><br><span class="line"><span class="addition">+       &#125;</span></span><br><span class="line"><span class="addition">+     ]</span></span><br><span class="line"><span class="addition">+   &#125;</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br></pre></td></tr></table></figure>

<p>上面，我们创建了一个引用自身另一部分的Schema，从而有效地在验证器中创建了一个“循环”，这既是允许的，也是有用的。但是请注意，相互<code>$ref</code>引用的Schema循环可能会在解析器中引起无限循环，因此明确不允许这样做。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- <span class="punctuation">&#123;</span></span><br><span class="line">-   <span class="attr">&quot;definitions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">-     <span class="attr">&quot;alice&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">-       <span class="attr">&quot;anyOf&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">-         <span class="punctuation">&#123;</span> <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/bob&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">-       <span class="punctuation">]</span></span><br><span class="line">-     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">-     <span class="attr">&quot;bob&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">-       <span class="attr">&quot;anyOf&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">-         <span class="punctuation">&#123;</span> <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/alice&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">-       <span class="punctuation">]</span></span><br><span class="line">-     <span class="punctuation">&#125;</span></span><br><span class="line">-   <span class="punctuation">&#125;</span></span><br><span class="line">- <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="在-id属性"><a href="#在-id属性" class="headerlink" title="在$id属性"></a>在$id属性</h2><p>该<code>$id</code>属性是一个URI引用，有两个用途：</p>
<ul>
<li>它为模式声明了唯一的标识符。</li>
<li>它声明一个基础URI，可以根据该基础URI$ref引用进行解析。</li>
</ul>
<p>最佳实践是，每个顶级Schema都应<code>$id</code>使用您控制的域设置为绝对URI（而不是相对引用）。例如，如果您拥有foo.bar域，并且具有地址Schema，则可以$id如下设置：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;$id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://foo.bar/schemas/address.json&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这为Schema提供了唯一的标识符，并且在大多数情况下，还可以指示哪里可以下载Schema。<br>但是请注意该<code>$id</code>属性的第二个用途：它为<code>$ref</code>文件中其他位置的URI引用声明一个基本URI 。例如，如果您有：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;person.json&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>在同一文件中，支持网络加载的JSON模式验证库可以从<a target="_blank" rel="noopener" href="http://foo.bar/schemas/person.json">http://foo.bar/schemas/person.json</a>加载person.json，甚至可以从别的地方加载address.json，例如本地文件系统。draft并未非常明确地定义行为的这一领域，验证器的实现可以尝试探索<code>$ref</code>的多种用法。<br>该<code>$id</code>属性绝不能为空字符串或空片段（<code>#</code>），因为这实际上没有任何意义。</p>
<h3 id="将-id与-ref一起使用"><a href="#将-id与-ref一起使用" class="headerlink" title="将$id与$ref一起使用"></a>将$id与$ref一起使用</h3><p><code>$id</code>还提供了一种无需使用JSON指针即可引用子模式的方法。这意味着您可以通过唯一的名称来引用它们，而不是通过它们在JSON树中出现的位置来引用。<br>重用上面的地址示例，我们可以将一个<code>$id</code>属性添加到地址Schema，然后通过该属性引用它。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://json-schema.org/draft-07/schema#&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;definitions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;$id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#address&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;street_address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span>           <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span>          <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;street_address&quot;</span><span class="punctuation">,</span> <span class="string">&quot;city&quot;</span><span class="punctuation">,</span> <span class="string">&quot;state&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;billing_address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#address&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;shipping_address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#address&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>笔记</strong><br>Python <code>jsonschema</code> 库当前不支持此功能。</p>
<h2 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h2><p><code>$ref</code>亮点在于，它被用来与关键词<code>allOf</code>，<code>anyOf</code>和<code>oneOf</code>相结合（见<a target="_blank" rel="noopener" href="https://json-schema.org/understanding-json-schema/reference/combining.html#combining">组合模式</a>）。<br>假设对于送货地址，我们想知道该地址是居住地址还是公司地址，因为所使用的送货方式可能取决于该地址。对于帐单邮寄地址，我们不希望存储该信息，因为它不适用。<br>为了解决这个问题，我们将更新送货地址的定义：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;shipping_address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/address&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>而是使用<code>allOf</code>结合了核心地址Schema定义和地址类型的额外Schema代码段的关键字条目：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;shipping_address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;allOf&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="comment">// Here, we include our &quot;core&quot; address schema...</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/address&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...and then extend it with stuff specific to a shipping</span></span><br><span class="line">    <span class="comment">// address</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;enum&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;residential&quot;</span><span class="punctuation">,</span> <span class="string">&quot;business&quot;</span> <span class="punctuation">]</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;type&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>绑在一起</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://json-schema.org/draft-06/schema#&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;definitions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;street_address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span>           <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span>          <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;street_address&quot;</span><span class="punctuation">,</span> <span class="string">&quot;city&quot;</span><span class="punctuation">,</span> <span class="string">&quot;state&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;billing_address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/address&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;shipping_address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;allOf&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/address&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span></span><br><span class="line">          <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;enum&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;residential&quot;</span><span class="punctuation">,</span> <span class="string">&quot;business&quot;</span> <span class="punctuation">]</span> <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;type&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这里验证失败，因为它缺少地址类型：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- &#123;</span></span><br><span class="line"><span class="deletion">-   &quot;shipping_address&quot;: &#123;</span></span><br><span class="line"><span class="deletion">-     &quot;street_address&quot;: &quot;1600 Pennsylvania Avenue NW&quot;,</span></span><br><span class="line"><span class="deletion">-     &quot;city&quot;: &quot;Washington&quot;,</span></span><br><span class="line"><span class="deletion">-     &quot;state&quot;: &quot;DC&quot;</span></span><br><span class="line"><span class="deletion">-   &#125;</span></span><br><span class="line"><span class="deletion">- &#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#123;</span></span><br><span class="line"><span class="addition">+   &quot;shipping_address&quot;: &#123;</span></span><br><span class="line"><span class="addition">+     &quot;street_address&quot;: &quot;1600 Pennsylvania Avenue NW&quot;,</span></span><br><span class="line"><span class="addition">+     &quot;city&quot;: &quot;Washington&quot;,</span></span><br><span class="line"><span class="addition">+     &quot;state&quot;: &quot;DC&quot;,</span></span><br><span class="line"><span class="addition">+     &quot;type&quot;: &quot;business&quot;</span></span><br><span class="line"><span class="addition">+   &#125;</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br></pre></td></tr></table></figure>

<p>从这些基本的片段中，无需大量重复就可以构建非常强大的模式。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guyver.icu/2023/02/24/AWS-DDB%E5%86%B7%E7%83%AD%E5%88%86%E7%A6%BB%E8%AE%BE%E8%AE%A1%E5%8D%87%E7%BA%A7%E7%89%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Guyver">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guyver's Blogs">
      <meta itemprop="description" content="没有困难的任务，只有勇敢的狗狗">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guyver's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/02/24/AWS-DDB%E5%86%B7%E7%83%AD%E5%88%86%E7%A6%BB%E8%AE%BE%E8%AE%A1%E5%8D%87%E7%BA%A7%E7%89%88/" class="post-title-link" itemprop="url">AWS DDB冷热分离设计升级版</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-02-24 11:08:41 / Modified: 12:02:18" itemprop="dateCreated datePublished" datetime="2023-02-24T11:08:41+08:00">2023-02-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>距离<a href="/2023/02/20/AWS-DDB%E5%86%B7%E7%83%AD%E5%88%86%E7%A6%BB%E8%AE%BE%E8%AE%A1/">上一次冷热分离</a>，过去两年，数据量进一步膨胀，但业务趋于稳定，<strong>降本增效</strong>成了此时的重点工作。</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>重新分析一次费用结构</p>
<ol>
<li>系统主要是C&#x2F;S架构，为了降本，我们下调了客户端同步数据的频率，以便减少对数据库的读写费用，AWS DDB存储费用又成了费用大户，业务场景上偏向于写多读少，即使每次业务查询都依赖S3费用也不高。</li>
<li>TTL过期机制，导致每个用户每天都会有一条数据过期，会重新读写一次S3</li>
<li>客户端时长范围性查询历史数据，命中S3，但由于很多用户只有一两年数据，导致会查询很多不存在的年文件，造成了S3查询浪费</li>
</ol>
<p>解决思路也比较直接</p>
<ol>
<li>AWS DDB存储费用贵，比较容易解决，<strong>缩短热数据时间</strong>，根据线上统计评估出最新读写频次，结合费用公式，计算出最优解在10天左右。</li>
<li>TTL一条条过期带来的S3读写频发， 可以通过<strong>批量合并写入</strong>的方式优化。</li>
<li>S3查询浪费，通过建立<strong>年文件索引</strong>或者将年文件改成<strong>用户全文件</strong>，避免S3 404</li>
</ol>
<p>在分析中，还发现了一个隐藏很深的BUG，这里由于数据不会立刻进去Lambda，<strong>刚过期的数据，不一定能被查询到</strong>。由于冷热边界是1年前，用户查询场景少，即使恰好被查询到无数据，用户也很难察觉，这个BUG一直没有被发现。但由于热数据时间缩短，该问题在新方案中必须得到解决。</p>
<blockquote>
<p>TTL过期机制是AWS DDB提供，底层原理是，DDB内数据存储在多个分区，类似Mysql的分区表，后台有两类线程定时扫描数据，线程一扫描和标记已过期数据，线程二将标记好的数据删除并写入DDB Stream。数据到期后不会立刻被扫描到，但AWS保证数据在48H内一定被删除掉，在标记后，仍然可以从DDB查询到，但是数据会被打上逻辑删除标识。<br>更多TTL介绍详见<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/TTL.html">官网网址</a></p>
</blockquote>
<h1 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h1><p>备选方案较多，下面介绍四种方案思路，其他变种方案不赘述</p>
<h2 id="方案一-批量合并"><a href="#方案一-批量合并" class="headerlink" title="方案一 批量合并"></a>方案一 批量合并</h2><p>DDB Stream的每条消息中，包含多条过期数据，由于分区内线程扫描的特性，如果我们将用户连续多天数据的TTL设置在同一时间过期，很大可能在同一条消息中的多条过期数据会是同一个用户的，能合并写入S3，一定程度上减少S3读写频次。<br>DDB存储降费通过缩短热数据时间，S3查询404通过年文件索引或用户全文件解决。<br>该方案的批量合并优化较弱，但胜在改动最简单。</p>
<h2 id="方案二-提前合并"><a href="#方案二-提前合并" class="headerlink" title="方案二 提前合并"></a>方案二 提前合并</h2><p>Lambda消费者程序，每次拿到一条过期数据，反查该用户的多天DDB数据，提前合并写入S3，并在公共暂存（例如redis）存储已写入的数据。后续这些已写入的数据过期后，Lambda程序消费时，会在暂存中发现已写入S3，则认为已消费。数据过期时间改成批量过期更好，不改也没关系。<br>DDB存储降费通过缩短热数据时间，S3查询404通过年文件索引或用户全文件解决。<br>该方案引入暂存，并反查一次DDB，优点不突出。</p>
<h2 id="方案三-暂存合并"><a href="#方案三-暂存合并" class="headerlink" title="方案三 暂存合并"></a>方案三 暂存合并</h2><p>数据过期后，暂存到公共暂存中，定时将暂存中的数据刷入S3。健康数据的底层查询依赖DDB、暂存和S3三个部分。<br>DDB存储降费通过缩短热数据时间，S3查询404通过年文件索引或用户全文件解决。<br>该方案引入暂存和定时任务，查询逻辑略复杂，优点不突出。</p>
<h2 id="（推荐）方案四-定时合并"><a href="#（推荐）方案四-定时合并" class="headerlink" title="（推荐）方案四 定时合并"></a>（推荐）方案四 定时合并</h2><p><strong>推荐</strong>，该方案演化了很长时间，这里重点介绍下最终版本。<br>每隔N天，全表扫描一次DDB，将所有数据一次性刷入S3。定时任务触发，每次任务结束后启用TTL功能，间隔48H禁用TTL。业务程序查询基于DDB和S3，写入则类似ES写入流程，增删改都当成数据变更，先入DDB，最后合并到ES。<br>定时任务选型较多，这里考虑到性能和技术复用，采用大数据领域的spark任务和airflow调动平台。<br>由于是统一归档，还可以很方便的制作增量备份大文件。<br>具备以下几个有点：</p>
<ol>
<li>依赖定时任务，在不同云厂商的其他数据库选型上更具备<strong>通用性</strong>，数据过期仍然依赖TTL但仅仅是负责清理已归档数据，在其他云数据库上容易找到替代技术。本方案移除了AWS Lambda，也节约了相当一部分费用。</li>
<li>定期全表扫描和刷入S3，由于热数据变少，全表扫描费用很少，但相比上面的方案零星读取写入，可以做历史数据做备份，在归档程序出错时，可以快速恢复，具备<strong>数据可恢复性</strong>。</li>
<li>不要求准确的冷热分界，可以很方便地根据业务需要调整热数据时间，<strong>灵活适配业务</strong>。</li>
<li>数据过期由于TTL手动开闭而变得可控，并且在定时调度或者归档程序出问题时，不会造成数据丢失，更具备<strong>容错性</strong>。</li>
</ol>
<p>在方案四的演进过程中，发现每个用户的核心数据大小相对稳定，在20年内数据未压缩时在数十M以内，S3上的数据采用gzip格式压缩，基于Deflate 算法，可流式解压，这意味着如果有序存储数据，即可在不用加载所有数据到内存中，查询到需要的数据，业务程序在查询时的<strong>JVM内存占用更小</strong>。幸运的是，甚至不用自己实现，<strong>AWS S3官方支持类似的select查询</strong>，且实测后费用很少，最后决定将每个用户的历史数据压缩成一个全文件，既减少了归档和业务查询时的S3读写，也大大减少了S3文件数，分析和管理费用也得到了一些优化。</p>
<blockquote>
<p>这里还有个<strong>关于TTL的插曲</strong>。早期在调研方案时，官方文档上在于TTL免费说的模棱两可，基于对AWS有钱不赚的刻板印象，在抱着怀疑态度咨询了AWS架构师后，没有得到满意答复，而后又咨询了AWS内部产品经理，得到了回复，TTL扫描标记特性不收费，但最终删除仍然收费。至此，方案中费用最贵的是数据归档后的清理费用，因为删除属于写操作，写:读单价比最高能达到40倍。但是，Drop表不收费，于是有了滚动表方案，查询和表的滚动切换很复杂。所幸后来一位<strong>敢于质疑权威</strong>的同学发现，<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/howitworks-ttl.html">英文版AWS文档</a>中关于TTL免费描述更清晰，于是我们做了测试，通过验证账单发现TTL功能确实免费，于是有了现在的方案四最终版。<br>AWS DDB的计费模式，强一致性读一条记录每4kb记做1rcu（不超过4kb也记为1rcu），最终一致性读便宜一半（我们在用），而写入和删除一条记录每1kb记为1wcu，而1个wcu的单价是1个rcu的5倍，也就是一条4kb的记录，写是读的40倍。</p>
</blockquote>
<h1 id="实施"><a href="#实施" class="headerlink" title="实施"></a>实施</h1><p><img src="/images/AWS-DDB%E5%86%B7%E7%83%AD%E5%88%86%E7%A6%BB%E8%AE%BE%E8%AE%A1%E5%8D%87%E7%BA%A7%E7%89%88/2023-02-24-00-14-41.png"><br>由于DDB和S3的读写都需要费用，尽量减少重试，归档中每个步骤需要的计算资源特点不尽相同，我们将归档任务切分上多个步骤，如上图所示。</p>
<ol>
<li>禁用TTL，shell脚本通过AWS CLI执行即可。此步为兜底动作，防止启用TTL的48H后未完成TTL禁用。</li>
<li>spark多并发，扫描DDB全表，将数据分片保存到S3</li>
<li>从S3拿到step2的DDB数据，按用户分组制作热数据备份，方便step5归档</li>
<li>从S3拿到step3的热数据备份，获取到所有用户ID，查询S3文件，保存到S3，制作冷数据备份，方便step5归档</li>
<li>从S3拿到热数据备份和冷数据备份，根据用户ID进行合并，并写入S3</li>
<li>归档后启用TTL功能，仍然是shell脚本触发，清理掉过期数据</li>
<li>48小时后，禁用TTL。由于我们的调度平台不支持延迟后置任务，这里使用一个小技巧，在某个地方记录上一次启用TTL时间，每隔一段时间尝试禁用TTL，如果距离上一次启用TTL时间超过48H，则禁用TTL，否则跳过。<br>实际airflow执行效果图如下<br><img src="/images/AWS-DDB%E5%86%B7%E7%83%AD%E5%88%86%E7%A6%BB%E8%AE%BE%E8%AE%A1%E5%8D%87%E7%BA%A7%E7%89%88/2023-02-24-00-15-41.png"></li>
</ol>
<h2 id="存量数据归档"><a href="#存量数据归档" class="headerlink" title="存量数据归档"></a>存量数据归档</h2><p>由于热数据时间缩短到10点，存量数据归档后需要将历史355天数据删除，自然冷却需要365天等不及，更新TTL使其立刻过期但太贵，Drop表免费是个好办法，但上线时需要额外的过渡程序兼容新老表并存场景。这里我们采用一个小技巧，TTL字段要求是秒级时间戳字段，当前时间比TTL小即表示数据过期，恰好该表有个createTime是秒级时间戳，是过去时间，先禁用TTL，再重新启用createTime作为TTL字段，即可将历史数据全部归档，为了防止将新数据也归档，改造程序另起一个临时字段realCreateTime存放创建时间，而新数据写入时，createTime设置成当前时间+1年，防止误清理。上线结束后，回退此改动即可，最终数据归档时，将realCreateTime写入createTime字段。</p>
<h2 id="上线步骤"><a href="#上线步骤" class="headerlink" title="上线步骤"></a>上线步骤</h2><ol>
<li>改造业务程序，重写createTime和realCreateTime字段的逻辑，并且模糊化冷热边界，查询采用merge逻辑，而不是之前根据时间判断冷热。</li>
<li>禁用TTL</li>
<li>归档存量数据</li>
<li>启用createTime作为新的TTL字段，清理DDB的已归档数据</li>
<li>48H后禁用TTL</li>
<li>…</li>
<li>下一轮归档，启用正式TTL字段</li>
</ol>
<h2 id="备份恢复"><a href="#备份恢复" class="headerlink" title="备份恢复"></a>备份恢复</h2><p>增量备份数据在S3上，以分片数据的形式保存，文件数少。因是备份增量数据，算是局部备份，存储费用有限。<br>每一轮归档都会涉及到的冷热数据做了备份，平时保留最近3个备份，可修复最近一个月内的故障数据。而第一次归档的备份是存量数据备份，可用于上线回滚。</p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>实际操作过程中，有很多注意事项。</p>
<ul>
<li><strong>拆分独立任务</strong>。扫描DDB全表因其不含业务逻辑，不易因BUG而重试，费用也贵，尽可能一次性成功，后面拆成独立任务也是一个道理。</li>
<li><strong>扫描前上调quota</strong>。防止造成表quota超限对实时业务造成影响</li>
<li><strong>合理配置分片数和并发度</strong>。在扫描DDB过程中，防止造成quota使用率低或者计算资源利用率低的浪费现象；</li>
<li><strong>建议quota不宜设置过高</strong>。费用是根据quota来计算的，并非实际吞吐，机器到位并发才能打满，吞吐才能达到预期，但并发高需要很多机器，平台申请时间比较长；另外quota auto scaling需要时间，任务结束后quota不会立刻下调，也无法手动下调，quota过大则浪费比较多。</li>
<li><strong>注意shuffle操作吃内存</strong>。制作热数据备份时，由于存在shuffle操作，且活跃和非活跃用户的数据存在一定倾斜，单个excutor并发设置1，内存要求更高。</li>
<li><strong>注意S3吞吐性能瓶颈</strong>。制作冷数据备份时，不存在shuffle，理论上可以通过调整并发线性提升效率，但由于S3吞吐性能无法上调，有初始吞吐上限。如果spark任务在yarn集群上因为分片任务失败，retry也需要费用。解决方法有二，其一，找AWS技术支持从后台手动调整S3分区数来上调吞吐性能，其二，S3在吞吐量过大的情况下会自动上调性能。这里我们穷，没有付费找技术支持，而是通过手写重试策略减少失败可能，并且通过取模分片，分多次慢慢试探S3吞吐瓶颈以便触发自动扩容机制。<blockquote>
<p>实践发现，S3读或写的吞吐持续10分钟打满(偶尔出现503限流)，即可触发自动扩容机制。</p>
</blockquote>
</li>
<li><strong>注意初次上线时意外重试</strong>。在刷入S3时，可能存在脏数据或者代码BUG导致整体任务失败，可以分多次刷，比如按1%-&gt;5%-&gt;20%-&gt;74%比例，用户ID取模，分四次刷入S3。</li>
<li><strong>合理使用按需实例和竞价实例</strong>。AWS提供了多种类型的计算实例，其中包括<a target="_blank" rel="noopener" href="https://aws.amazon.com/cn/ec2/pricing/on-demand/">按需实例</a>和<a target="_blank" rel="noopener" href="https://aws.amazon.com/cn/ec2/spot/pricing/">竞价实例</a>，按需稳定但昂贵，竞价便宜但不稳定，任务时间短(处理数据少的区)或者允许重试的任务推荐竞价实例，重试成本昂贵的任务推荐按需实例。实践过程中，存量数据处理任务耗时长且重试成本高，一些数据中心竞价实例极不稳定且申请慢，还有Spark Driver节点要求稳定性高，这些需要使用按需实例，其他场景都一律使用竞价实例。</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本方案在不断碰撞中演化，评估、制定和实施耗时较长。<br>尤其在评估阶段，需要充分考虑不同云厂商的技术通用性、数据可恢复性、系统容错性和灵活性，保证方案的系统复杂度和降费目标达到一个相对平衡的状态；在实施阶段，需要考虑用户无感上线，上线意外时回滚方案；在维护阶段，考虑日常故障的容错性和数据可恢复性。<br>最终完成的降费效果还是很可观的，系统复杂度相对之前略高，但整体设计更优。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guyver.icu/2023/02/20/AWS-DDB%E5%86%B7%E7%83%AD%E5%88%86%E7%A6%BB%E8%AE%BE%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Guyver">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guyver's Blogs">
      <meta itemprop="description" content="没有困难的任务，只有勇敢的狗狗">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guyver's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/02/20/AWS-DDB%E5%86%B7%E7%83%AD%E5%88%86%E7%A6%BB%E8%AE%BE%E8%AE%A1/" class="post-title-link" itemprop="url">AWS DDB冷热分离设计</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-02-20 23:14:18" itemprop="dateCreated datePublished" datetime="2023-02-20T23:14:18+08:00">2023-02-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-02-24 11:31:39" itemprop="dateModified" datetime="2023-02-24T11:31:39+08:00">2023-02-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>公司早期业务快速增长时，出于运维成本、稳定性和性能考虑，选择公有云部署。由于和小米工作合作紧密且小米生态云优惠力度大，早期部署在<a target="_blank" rel="noopener" href="https://cnbj6.cloud.mi.com/">小米生态云</a>上。其中核心健康数据规模大，增长快，业务变化快，字段灵活，但查询条件简单，技术选型使用<a target="_blank" rel="noopener" href="https://cnbj6.cloud.mi.com/#/index/product/sds">NoSQL数据库SDS</a>。<br>但随着业务发展越来越大，小米生态云的稳定性问题暴露出来，为了保障用户体验和提高服务可用性，公司选择了在全球范围内更加成熟稳定的<a target="_blank" rel="noopener" href="https://aws.amazon.com/">亚马逊AWS</a>，对标的NoSQL数据库是<a target="_blank" rel="noopener" href="https://www.amazonaws.cn/dynamodb/">AWS DynamoDB</a>，但<strong>AWS DDB费用较贵，于是在迁移云服务更换数据库时，对底层存储设计进行优化升级</strong>。</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>在迁移云时，由于是toC业务，需要保证用户体验，不能停服割接，采用<strong>蚂蚁搬家</strong>的方式，针对每个用户逐一进行迁移，迁移过程中，冻结用户操作，对用户仅有分钟级的影响，甚至仅影响写操作，不影响读。<br>虽然按用户迁移耗时长，费用高，但过程可控，风险低，一边灰度一边观察用户反馈，迁移云过程不是本文重点，不做详细描述。<br>AWS DDB存储费用相比IOPS高很多，存在明显的优化空间。在业务趋势稳定后，以降费为目标，对<strong>云端服务费用进行分析和优化</strong>。<br>对数据的读写进行监控，发现数据读写呈现出明显的冷热分界，且在SDS上表现确实存储费用占比较大，属于典型的冷热数据。AWS DDB针对冷热场景提供了<a target="_blank" rel="noopener" href="https://www.amazonaws.cn/dynamodb/dynamodb-standard-ia/">DDB IA模式</a>，Storage&#x2F;IOPS费用比超过6:4，即可启用IA进行降费，但通过计算，使用<strong>冷热分离方案降费更优</strong>。</p>
<h1 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h1><p>冷热分离有以下几个问题需要解决</p>
<ul>
<li>冷存储如何选型</li>
<li>业务程序如何改造</li>
<li>增量数据如何转移到冷存储</li>
<li>存量数据如何转移到冷存储</li>
</ul>
<h2 id="冷存储如何选型"><a href="#冷存储如何选型" class="headerlink" title="冷存储如何选型"></a>冷存储如何选型</h2><p>取决于成本、业务程序查询是否方便、增量数据转移是否方便，通过和AWS架构师的深入交流，详细分析了AWS托管的各种存储特性和成本模型，冷存储选型决定使用<a target="_blank" rel="noopener" href="https://www.amazonaws.cn/s3/">AWS S3</a>。</p>
<h2 id="业务程序如何改造"><a href="#业务程序如何改造" class="headerlink" title="业务程序如何改造"></a>业务程序如何改造</h2><p>健康数据的查询，多是以周、双周、月、年粒度，考虑到S3的费用按查询次数计费，内网调用没有出网流量费用，管理和分析等其他功能多是和文件数正相关，文件粒度不宜太小。但太大的文件，业务程序查询时，需要加载文件到内存中，会给JVM内存要求高且费用会上升，综合考虑，<strong>以年为单位存储用户冷数据</strong>。<br>通过对数据的查询时间范围做分析，<strong>以365天做冷热分界点</strong>，业务程序在查询近期数据时，使用DDB，查询历史数据是，使用S3。</p>
<h2 id="增量数据如何转移到冷存储"><a href="#增量数据如何转移到冷存储" class="headerlink" title="增量数据如何转移到冷存储"></a>增量数据如何转移到冷存储</h2><p>DDB到S3的数据转移，AWS提供了成熟的方案，利用DDB TTL特性，数据过期后将从数据库中移除，可以通过<a target="_blank" rel="noopener" href="https://www.amazonaws.cn/lambda">AWS Lambda</a>对接Dynamo DDB Stream，拿到被移除的数据，写入S3中。<br>每天近千万的数据过期，被转移到S3中，过期时间虽有波峰波谷，但不至过于集中产生毛刺，使用AWS Lambda支持自动扩缩容，S3吞吐量也支持自动扩容，性能和稳定性有保障。<br>在可用性方面，AWS Lambda支持消费retry和死信队列，也支持配置AWS Cloud Watch监控和告警。</p>
<p><img src="/images/AWS-DDB%E5%86%B7%E7%83%AD%E5%88%86%E7%A6%BB%E8%AE%BE%E8%AE%A1/2023-02-19-16-20-25.png"></p>
<h2 id="存量数据如何转移到冷存储"><a href="#存量数据如何转移到冷存储" class="headerlink" title="存量数据如何转移到冷存储"></a>存量数据如何转移到冷存储</h2><p>由于迁移云是用户粒度的迁移，在一个用户的数据被完整的导入另一个区时，先写入DDB，然后根据数据的时间字段，设置TTL，如果是冷数据，将会很快被淘汰到S3中，热数据仍然会保留在DDB中，等待自然冷却。<br>AWS DDB不同于一般的云托管数据库，并不是按资源配置收费，而是按用量收费，主要费用是存储、IOPS和其他分析管理费用，其中写（增删改）单价是读单价的20~40倍。如果不是趁着迁移云时给存量数据设计TTL，迁移后如果再想修改TTL，则相当于对全量数据进行一次写操作，<strong>收费极其昂贵</strong>。<br>事后分析迁移云费用时，发现让历史数据先入DDB再走冷却流程，会耗费DDB写和Lambda费用，后续其他数据中心的云迁移中，对此在进行了优化，在迁移程序中，直接将历史数据中的冷数据部分直接写入S3，由于冷数据占比大，仅此一项，直接节约5成数据迁移费用。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>存储费用高昂，业务上数据冷热特征明显，冷热分离是比较容易想到的常规方案。<br>挑战在于如何在较大数据规模下，如何对用户无感地灰度上线，以及兼顾费用成本、维护成本、改造成本、方案在不同云上的兼容性，综合考虑出一个合理的方案。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Guyver</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
